$(".preload").addClass("d-flex");var exchangeRateValue=24567,table=null,frm=null,approvalNames={};const siteNameSheetInit="LH PX_Customer_Master_Listing_Rep",columnvalidateYes=[0,1,2,4,5,10,11,12,13,14,17,18],columnvalidateNo=[0,1,2,4,5,10,11,12,13,14],slBc=document.getElementById("sl-bill-code"),ctCcy=document.querySelector(".js-curency"),slD2D=document.getElementById("sl-D2D-price"),readFFee=document.querySelector(".js-freightfee"),slEXR=document.getElementById("sl-Different-exchange"),readEXR=document.querySelector(".js-read-Exchange-rate"),rowExchange=document.querySelector(".exchange-row"),slWC=document.getElementById("sl-weighted-cm"),inRBrebate=document.querySelector(".js-rb-rebate"),btnSubglid=document.getElementById("btn-submit-glid"),vlbtoCode=document.querySelector(".filter-option-inner-inner");function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("movetop").style.display="block":document.getElementById("movetop").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}function slSite(){$(".preload").addClass("d-flex");var e=document.getElementById("sl-site").value,t="";document.getElementsByName("billname")[0].value="",document.getElementsByName("curency")[0].value="",t="LH"==e?"LH PX_Customer_Master_Listing_Rep":"BN"==e?"BN PX_Customer_Master_Listing_Rep":"KH PX_Customer_Master_Listing_Rep",google.script.run.withFailureHandler(getDataFail).withSuccessHandler(getbilltoCode).getData(t)}function getbilltoCode(e){$("#sl-bill-code").selectpicker("destroy"),$("#sl-bill-code").find("option").remove().end();var t="";e.forEach(((e,l)=>{t+=`<option class="option-select" value="${e.btoName}"  option-piece="${e.curency}" title="${e.btoCode}" >${e.btoCode}</option>`})),$("#sl-bill-code").append(t).selectpicker(),$(".preload").removeClass("d-flex")}function calculateNeededSpecialPrice(){"USD"==ctCcy.value?"No"==$("#sl-D2D-price").val()?null!=table&&null!=table.getJson()&&table.getJson().map(((e,t)=>{""!=table.getValueFromCoords(0,t,!1)&&(table.setValueFromCoords(10,t,"freetext",!0),table.setValueFromCoords(11,t,"",!0),table.getCellFromCoords(10,t).classList.remove("readonly"))})):null!=table&&table.getJson().length>0&&table.getJson().map(((e,t)=>{if(table.getCellFromCoords(10,t).classList.add("readonly"),""!=table.getValueFromCoords(0,t,!1)&&""!=table.getValueFromCoords(6,t,!1)&&""!=$(".js-freightfee").val())try{table.setValueFromCoords(10,t,(parseFloat(table.getValueFromCoords(6,t,!1))+parseFloat($(".js-freightfee").val())).toFixed(5),!0),calculateCM(t)}catch{return}})):"No"==$("#sl-D2D-price").val()?"No"==$("#sl-Different-exchange").val()?null!=table&&null!=table.getJson()&&table.getJson().map(((e,t)=>{""!=table.getValueFromCoords(0,t,!1)&&(table.setValueFromCoords(10,t,"freetext",!0),table.setValueFromCoords(11,t,"",!0),table.getCellFromCoords(10,t).classList.remove("readonly"))})):null!=table&&null!=table.getJson()&&table.getJson().map(((e,t)=>{if(table.getCellFromCoords(10,t).classList.add("readonly"),""!=table.getValueFromCoords(0,t,!1)&&""!=table.getValueFromCoords(6,t,!1)&&""!=$(".js-read-Exchange-rate").val())try{table.setValueFromCoords(10,t,(parseFloat(table.getValueFromCoords(6,t,!1))*parseFloat($(".js-read-Exchange-rate").val())).toFixed(5),!0),calculateCM(t)}catch{return}})):"No"==$("#sl-Different-exchange").val()?null!=table&&null!=table.getJson()&&table.getJson().map(((e,t)=>{if(table.getCellFromCoords(10,t).classList.add("readonly"),""!=table.getValueFromCoords(0,t,!1)&&""!=table.getValueFromCoords(7,t,!1)&&""!=$(".js-freightfee").val())try{table.setValueFromCoords(10,t,(parseFloat(table.getValueFromCoords(7,t,!1))+parseFloat($(".js-freightfee").val())).toFixed(5),!0),calculateCM(t)}catch{return}})):null!=table&&null!=table.getJson()&&table.getJson().map(((e,t)=>{if(table.getCellFromCoords(10,t).classList.add("readonly"),""!=table.getValueFromCoords(0,t,!1)&&""!=table.getValueFromCoords(6,t,!1)&&""!=$(".js-read-Exchange-rate").val()&&""!=$(".js-freightfee").val())try{table.setValueFromCoords(10,t,(parseFloat(table.getValueFromCoords(6,t,!1))*parseFloat($(".js-read-Exchange-rate").val())+parseFloat($(".js-freightfee").val())).toFixed(5),!0),calculateCM(t)}catch{return}}))}function calculateCM(e){"VND"==$(".js-curency").val()?($(".js-read-Exchange-rate").val()?exchangeRateValue=$(".js-read-Exchange-rate").val():$(".js-read-Exchange-rate").val(exchangeRateValue),""!=table.getValueFromCoords(0,e,!1)&&(""!=$(".js-rb-rebate").val()?table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(table.getValueFromCoords(10,e,!1))*(1-parseFloat($(".js-rb-rebate").val())/100)-parseFloat(table.getValueFromCoords(5,e,!1))*parseFloat(exchangeRateValue))/(parseFloat(table.getValueFromCoords(10,e,!1))*(1-parseFloat($(".js-rb-rebate").val())/100)))).toFixed(0),!0):table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(table.getValueFromCoords(10,e,!1))-parseFloat(table.getValueFromCoords(5,e,!1))*parseFloat(exchangeRateValue))/parseFloat(table.getValueFromCoords(10,e,!1)))).toFixed(0),!0))):""!=table.getValueFromCoords(0,e,!1)&&(""!=$(".js-rb-rebate").val()?table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(table.getValueFromCoords(10,e,!1))*(1-parseFloat($(".js-rb-rebate").val())/100)-parseFloat(table.getValueFromCoords(5,e,!1)))/(parseFloat(table.getValueFromCoords(10,e,!1))*(1-parseFloat($(".js-rb-rebate").val())/100)))).toFixed(0),!0):table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(table.getValueFromCoords(10,e,!1))-parseFloat(table.getValueFromCoords(5,e,!1)))/parseFloat(table.getValueFromCoords(10,e,!1)))).toFixed(0),!0))}function calculateCMDirectly(e,t){"VND"==$(".js-curency").val()?($(".js-read-Exchange-rate").val()?exchangeRateValue=$(".js-read-Exchange-rate").val():$(".js-read-Exchange-rate").val(exchangeRateValue),""!=table.getValueFromCoords(0,e,!1)&&(""!=$(".js-rb-rebate").val()?table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(t)*(1-parseFloat($(".js-rb-rebate").val())/100)-parseFloat(table.getValueFromCoords(5,e,!1))*parseFloat(exchangeRateValue))/(parseFloat(t)*(1-parseFloat($(".js-rb-rebate").val())/100)))).toFixed(0),!0):table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(t)-parseFloat(table.getValueFromCoords(5,e,!1))*parseFloat(exchangeRateValue))/parseFloat(t))).toFixed(0),!0))):""!=table.getValueFromCoords(0,e,!1)&&(""!=$(".js-rb-rebate").val()?table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(t)*(1-parseFloat($(".js-rb-rebate").val())/100)-parseFloat(table.getValueFromCoords(5,e,!1)))/(parseFloat(t)*(1-parseFloat($(".js-rb-rebate").val())/100)))).toFixed(0),!0):table.setValueFromCoords(11,e,(100*parseFloat((parseFloat(t)-parseFloat(table.getValueFromCoords(5,e,!1)))/parseFloat(t))).toFixed(0),!0))}function calculateTotalSales(){var e=table.getColumnData(19).filter((e=>!isNaN(e)&&isFinite(e)&&""!=e));console.log(e),e.length>0&&($("#total-ttlsales-val").val(e.reduce(((e,t)=>e+parseFloat(t)),0)),console.log("sum: ",$("#total-ttlsales-val").val()),$("#total-ttlsales").empty().text($("#total-ttlsales-val").val()),""!=$(".js-rb-rebate").val()?""!=$("#total-ttlcost-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100)-$("#total-ttlcost-val").val())/(parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100))).toFixed(0)),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$("#total-weightedcm").empty().text("")):""!=$("#total-ttlcost-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())-$("#total-ttlcost-val").val())/parseFloat($("#total-ttlsales-val").val())).toFixed(0)),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$("#total-weightedcm").empty().text("")))}function calculateTotalCost(){var e=table.getColumnData(20).filter((e=>!isNaN(e)&&isFinite(e)&&""!=e));e.length>0&&($("#total-ttlcost-val").val(e.reduce(((e,t)=>e+parseFloat(t)),0)),$("#total-ttlcost").empty().text($("#total-ttlcost-val").val()),""!=$(".js-rb-rebate").val()?""!=$("#total-ttlsales-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100)-$("#total-ttlcost-val").val())/(parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100))).toFixed(0)),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$("#total-weightedcm").empty().text("")):""!=$("#total-ttlsales-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())-$("#total-ttlcost-val").val())/parseFloat($("#total-ttlsales-val").val())).toFixed(0)),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$("#total-weightedcm").empty().text("")))}function getDataFail(e){$(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:"Error! Pls try again",showConfirmButton:!0})}function insertRow(){var e=parseInt(document.getElementById("txt-row").value);table.insertRow(e)}function userData(e){null==e&&Swal.fire({icon:"error",title:"Error! Cannot get username",showConfirmButton:!0}),$("#requestor").empty().text(e.displayname),approvalNames=e}window.onscroll=function(){scrollFunction()},slWC.onchange=function(){null!=table&&("Yes"==this.value?(table.showColumn(17),table.showColumn(18),table.showColumn(19),table.showColumn(20)):(table.hideColumn(17),table.hideColumn(18),table.hideColumn(19),table.hideColumn(20)))},inRBrebate.onchange=function(){isNaN(this.value)||null!=table&&null!=table.getJson()&&(table.getJson().map(((e,t)=>{try{calculateCM(t)}catch{return}})),calculateTotalSales(),calculateTotalCost())},readFFee.onchange=function(){isNaN(this.value)||""!=this.value&&calculateNeededSpecialPrice()},readEXR.onchange=function(){isNaN(this.value)||""!=this.value&&(calculateNeededSpecialPrice(),null!=table&&null!=table.getJson()&&table.getJson().map(((e,t)=>{try{calculateCM(t)}catch{return}})))},slD2D.onchange=function(){const e=slD2D.options[slD2D.selectedIndex].value;console.log(e),"No"==e?($(".js-freightfee").rules("remove","required"),$(".js-freightfee").removeAttr("required"),readFFee.readOnly=!0,readFFee.value="",calculateNeededSpecialPrice()):(readFFee.readOnly=!1,$(".js-freightfee").rules("add","required"),$(".js-freightfee").attr("required",!0),calculateNeededSpecialPrice())},slEXR.onchange=function(){"No"==slEXR.options[slEXR.selectedIndex].value?(readEXR.readOnly=!0,$(".js-read-Exchange-rate").rules("remove","required"),$(".js-read-Exchange-rate").removeAttr("required"),readEXR.value="",calculateNeededSpecialPrice()):(readEXR.readOnly=!1,$(".js-read-Exchange-rate").rules("add","required"),$(".js-read-Exchange-rate").attr("required",!0),calculateNeededSpecialPrice())},slBc.onchange=function(){const e=slBc.options,t=e[slBc.selectedIndex].value,l=e[slBc.selectedIndex].getAttribute("option-piece");document.getElementsByName("billname")[0].value=t,document.getElementsByName("curency")[0].value=l,calculateNeededSpecialPrice(),"USD"==ctCcy.value?(rowExchange.style.display="none",$("#sl-Different-exchange").rules("remove","required"),$(".js-read-Exchange-rate").rules("remove","required"),$(".js-read-Exchange-rate").removeAttr("required")):(rowExchange.style.display="flex",$("#sl-Different-exchange").rules("add","required"),$(".js-read-Exchange-rate").rules("add","required"),$(".js-read-Exchange-rate").attr("required",!0))},google.script.run.withSuccessHandler((e=>{if(null==e.users)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"You do not have permission to access this page! Please contact to sales admin",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1});exchangeRateValue=parseInt(e.exchangerate),$(".js-read-Exchange-rate").val(exchangeRateValue),getbilltoCode(e.billtocode);table=jspreadsheet(document.getElementById("spreadsheet"),{minDimensions:[10,5],tableOverflow:!0,allowDeleteColumn:!1,allowManualInsertColumn:!1,allowInsertColumn:!1,rowResize:!0,columns:[{type:"text",title:"GLID",width:"150",name:"glid",id:"required",readOnly:!1},{type:"text",title:"Sold To Name",width:"150",id:"readonly",name:"soldtoname",readOnly:!0},{type:"text",title:"Customer Item",width:"150",name:"customeritem",id:"readonly",readOnly:!0},{type:"text",title:"Production Method",width:"150",id:"readonly",name:"productionmethod",readOnly:!0},{type:"dropdown",title:"Make/Buy",width:"120",name:"makebuy",id:"readonly",source:["Make","Buy"],readOnly:!0},{type:"text",title:"Cost",width:"100",name:"cost",id:"readonly",readOnly:!0},{type:"number",title:"Std price\n(USD)",width:"120",id:"readonly",name:"stdpriceusd",readOnly:!0},{type:"number",title:"Std price\n(VND)",width:"80",name:"stdpricevnd",id:"readonly",readOnly:!0},{type:"number",title:"Current special price\n(USD)",width:"160",name:"currentspecialpriceusd",id:"readonly",readOnly:!0},{type:"number",title:"Current special price\n(VND)",width:"160",name:"currentspecialpricevnd",id:"readonly",readOnly:!0},{type:"number",title:"Needed special\nprice",width:"170",name:"neededspecialprice",id:"readonly",readOnly:!0},{type:"number",title:"CM",width:"100",name:"cm",id:"readonly",readOnly:!0},{type:"dropdown",title:"RB",width:"150",id:"required",name:"rb",autocomplete:!0,source:e.rbos},{type:"dropdown",title:"Production",width:"150",id:"required",name:"productline",autocomplete:!0,source:e.plmake.concat(e.plbuy),filter:function(t,l,a,o,r){switch(t.jspreadsheet.getValueFromCoords(4,o,!1)){case"Make":return e.plmake;case"Buy":return e.plbuy;default:return e.plmake.concat(e.plbuy)}}},{type:"dropdown",title:"Market Segment",width:"150",id:"required",name:"marketsegment",autocomplete:!0,readOnly:!1,source:e.markets},{type:"text",title:"Approval level",width:"140",name:"approvallevel",id:"readonly",readOnly:!0},{type:"dropdown",title:"GPD in charge",width:"140",name:"gpdincharge",autocomplete:!0,readOnly:!1,source:e.gpd,multiple:!0},{type:"number",title:"TTL Sales QTY",width:"140",id:"required",name:"ttlsalesqty"},{type:"number",title:"TTL Produced QTY\n(if there alignment\n of free loss)",width:"160",id:"required",name:"ttlproducedqty"},{type:"number",title:"TTL sales",width:"100",name:"ttlsales",id:"readonly",readOnly:!0},{type:"number",title:"TTL cost",width:"100",name:"ttlcost",id:"readonly",readOnly:!0}],onbeforechange:function(t,l,a,o,r){switch(parseInt(a)){case 10:l.classList.contains("readonly")||calculateCMDirectly(parseInt(o),r);try{"VND"==$(".js-curency").val()?table.setValueFromCoords(19,o,(parseFloat(r)*(parseFloat(table.getValueFromCoords(17,o,!1))/parseFloat($(".js-read-Exchange-rate").val()))).toFixed(0),!0):table.setValueFromCoords(19,o,(parseFloat(r)*parseFloat(table.getValueFromCoords(17,o,!1))).toFixed(0),!0),calculateTotalSales()}catch{return table.setValueFromCoords(19,o,"",!0),$("#total-ttlsales-val").val(""),$("#total-ttlcost-val").val(""),$("#total-weightedcm-val").val(""),$("#total-ttlsales").empty().text(""),$("#total-ttlcost").empty().text(""),void $("#total-weightedcm").empty().text("")}break;case 12:const t=e.lkrbms.filter((e=>{if(e[0]==r)return e[1]}));return void(0!=t.length?(table.setValueFromCoords(14,o,t[0][1],!0),table.getCellFromCoords(14,o).style.border="1px solid #ccc"):(table.setValueFromCoords(14,o,"",!0),table.getCellFromCoords(14,o).style.border="1px solid red"));case 17:try{"VND"==$(".js-curency").val()?table.setValueFromCoords(19,o,(parseFloat(table.getValueFromCoords(10,o,!1))*(parseFloat(r)/parseFloat($(".js-read-Exchange-rate").val()))).toFixed(0),!0):table.setValueFromCoords(19,o,(parseFloat(table.getValueFromCoords(10,o,!1))*parseFloat(r)).toFixed(0),!0),calculateTotalSales()}catch{return table.setValueFromCoords(19,o,"",!0),$("#total-ttlsales-val").val(""),$("#total-ttlcost-val").val(""),$("#total-weightedcm-val").val(""),$("#total-ttlsales").empty().text(""),$("#total-ttlcost").empty().text(""),void $("#total-weightedcm").empty().text("")}break;case 18:try{table.setValueFromCoords(20,o,(parseFloat(r)*parseFloat(table.getValueFromCoords(5,o,!1))).toFixed(0),!0),calculateTotalCost()}catch{return table.setValueFromCoords(20,o,"",!0),$("#total-ttlsales-val").val(""),$("#total-ttlcost-val").val(""),$("#total-weightedcm-val").val(""),$("#total-ttlsales").empty().text(""),$("#total-ttlcost").empty().text(""),void $("#total-weightedcm").empty().text("")}break;default:return r}},onchange:function(e,t,l,a,o,r){switch(parseInt(l)){case 0:r!=o&&($("#btn-submit-glid").show(),$("#btn-submit").hide());break;case 4:if(o!=r){var s=jspreadsheet.helpers.getColumnNameFromCoords(13,a);table.setValue(s,"")}break;case 10:case 11:case 12:case 13:case 14:o!=r&&($("#btn-submit").hide(),$("#btn-submit-glid").show())}},onpaste(e,t){if(!(t[0].length>21))return t;Swal.fire({icon:"error",title:"Value you just pasted is longer than the length of the table. Do not submit! Pls check again",showConfirmButton:!0})}}),userData(e.users),$(".preload").removeClass("d-flex")})).getInitalDataAsync(siteNameSheetInit);const promiseGetDataPX=(e,t,l)=>new Promise(((a,o)=>{$.ajax({url:"https://vnfastrack.averydennison.net/priceanddiscount/tucanagetpxdata",dataType:"JSON",async:!1,type:"post",data:{site:e,currency:t,glids:l},success:function(e){a(e)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error"),o()}})})),promiseGetDataDC=(e,t,l)=>new Promise(((a,o)=>{$.ajax({url:"https://vnfastrack.averydennison.net/priceanddiscount/tucanagetdcdata",dataType:"JSON",async:!1,type:"post",data:{site:e,currency:t,glids:l},success:function(e){a(e)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error"),o()}})})),promisePreviewData=()=>new Promise(((e,t)=>{if($("#form-submit").valid()){var l=table.getJson(),a=[],o=0,r=[];if(l.map(((e,t)=>{Object.keys(e).every((t=>""==e[t]))||(e.index=t,r.push(e))})),r.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});if(!r.every((e=>e.rb==r[0].rb)))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"RB not same!",showConfirmButton:!0});if(!r.every((e=>e.makebuy==r[0].makebuy)))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/ Buy items not same!",showConfirmButton:!0});for(var s=[],n=[],i=0;i<r.length;i++){var d=0;for(var c in l[i]){if(""===l[i][c]&&[0,5,11,12,13,14].includes(d))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:c+" at row "+(i+1)+" is blank. Pls check again!",showConfirmButton:!0});d++}if("!err"==l[i].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("!err"==l[i].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("NaN"==l[i].neededspecialprice)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Needed special price: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("NaN"==l[i].cm)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("Yes"==$("#sl-weighted-cm").val()){if("NaN"==l[i].ttlsales)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL sales: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("NaN"==l[i].ttlcost)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL Cost: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0})}if(o++,22!=Object.keys(l[i]).length)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Total table column != 22. Pls check again",showConfirmButton:!0});$("#form-submit").serializeArray().map(((e,t)=>{l[i][e.name]=e.value})),l[i].billcode=$("#sl-bill-code").find("option:selected").text(),l[i].totalttlsales=$("#total-ttlsales-val").val(),l[i].totalttlcost=$("#total-ttlcost-val").val(),l[i].totalweightedcm=$("#total-weightedcm-val").val(),-1==s.indexOf(l[i].productline)&&s.push(`"${l[i].productline}"`),-1==n.indexOf(l[i].marketsegment)&&n.push(`"${l[i].marketsegment}"`),a.push({...l[i]})}if(0==o)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){null!=e?(null==e[1]&&console.log("GPD in charge not found!"),null!=e[0]&&(console.log(e),a.map(((t,l)=>{if(null!=e[1]){var a=e[1].filter((e=>e.productline==t.productline));a.length>0&&(t.gpdincharge=a.map((e=>e.gpd)).join(";"),table.setValueFromCoords(16,t.index,t.gpdincharge,!0))}var o=e[0].filter((e=>e.productline==t.productline&&e.rb==t.rb&&e.marketsegment==t.marketsegment&&e.mincm<=t.cm&&e.maxcm>=t.cm));o.length>0&&(t.approvallevel=o[0].level,table.setValueFromCoords(15,t.index,o[0].level,!0))})),console.log(a),$("#btn-submit").show(),$("#btn-submit-glid").hide(),$(".preload").removeClass("d-flex"))):($(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:l.msg,showConfirmButton:!0}))})).GetApprovalAndGPDData(a[0].makebuy,a[0].rb,s.join(","),n.join(","),a[0].tcnsite)}else $(".preload").removeClass("d-flex")}));function getDataPX(e,t,l){$.ajax({url:"https://vnfastrack.averydennison.net/priceanddiscount/tucanagetpxdata",dataType:"JSON",async:!1,type:"post",data:{site:e,currency:t,glids:l},success:function(e){if(e.results){l.length>5&&table.insertRow(l.length-5);const t=[],a=e.results.filter((e=>0==e.from));a.length>0&&(a.forEach(((e,l,o)=>{let r=l;for(let t=l+1;t<a.length;++t){a[t].item==e.item&&t.id<e.id&&(r=t)}let s=a[r];t.some((e=>e.item==s.item))||t.push(s)})),console.log("filteredArrUSD:",t));const o=[],r=e.results.filter((e=>1==e.from));r.length>0&&(r.forEach(((e,t,l)=>{let a=t;for(let l=t+1;l<r.length;++l){r[l].item==e.item&&l.id<e.id&&(a=l)}let s=r[a];o.some((e=>e.item==s.item))||o.push(s)})),console.log("filteredArrVND:",o)),l.map(((e,l)=>{var a=t.filter((t=>t.item==e));a.length<=0?(table.setValueFromCoords(0,l,e,!0),table.setValueFromCoords(1,l,null,!0),table.setValueFromCoords(2,l,null,!0),table.setValueFromCoords(3,l,null,!0),table.setValueFromCoords(4,l,null,!0),table.setValueFromCoords(5,l,null,!0),table.setValueFromCoords(6,l,null,!0)):(table.setValueFromCoords(0,l,a[0].item,!0),table.setValueFromCoords(1,l,a[0].soldtoname,!0),table.setValueFromCoords(2,l,a[0].customeritem,!0),table.setValueFromCoords(3,l,a[0].productionmethod,!0),table.setValueFromCoords(4,l,a[0].makebuyer,!0),table.setValueFromCoords(5,l,a[0].pendingmaterialcost,!0),table.setValueFromCoords(6,l,a[0].price,!0),o.filter((t=>t.item==e)).length>0&&table.setValueFromCoords(7,l,o.filter((t=>t.item==e))[0].price,!0))}))}}})}function getDataDC(e,t,l){$.ajax({url:"https://vnfastrack.averydennison.net/priceanddiscount/tucanagetdcdata",dataType:"JSON",async:!1,type:"post",data:{site:e,currency:t,glids:l},success:function(e){if(e.results){console.log("discount datas:"),console.log(e.results);const t=ctCcy.value,a=`VN${$("#sl-bill-code").find("option:selected").text()}`;switch(t){case"USD":l.map(((t,l)=>{console.log(`table.getValueFromCoords(0, ${l}, false) = ${table.getValueFromCoords(0,l,!1)}`);var o=e.results.filter((e=>0==e.from&&e.oracleitem==t&&e.modifiernumber==a));if(o.length>0)if(o.filter((e=>null!=e.discountprice)).length>0){if(o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))){var r=o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate)).map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YYYY").format("DD/MMM/YYYY"),"days")));console.log("max date: ",Math.max(...r)),table.setValueFromCoords(8,l,o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))[r.indexOf(Math.max(...r))].discountprice,!0)}}else console.log("discount price null"),table.setValueFromCoords(8,l,table.getValueFromCoords(6,l,!1),!0);else console.log("glid with discountc price not found"),table.setValueFromCoords(8,l,table.getValueFromCoords(6,l,!1),!0)}));break;case"VND":l.map(((t,l)=>{console.log(`table.getValueFromCoords(0, ${l}, false) = ${t}`);var o=e.results.filter((e=>1==e.from&&e.oracleitem==t&&e.modifiernumber==a));if(o.length>0)if(o.filter((e=>null!=e.discountprice)).length>0){if(o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))){var r=o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate)).map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YY").format("DD/MM/YYYY"),"days")));console.log("max date: ",Math.max(...r)),table.setValueFromCoords(9,l,o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))[r.indexOf(Math.max(...r))].discountprice,!0)}}else console.log("discount price null"),table.setValueFromCoords(9,l,table.getValueFromCoords(7,l,!1),!0);else console.log("glid with discountc price not found"),table.setValueFromCoords(9,l,table.getValueFromCoords(7,l,!1),!0)}))}}}})}function findUserRef(e,t){$("#level-2").empty().text(""),$("#level-3").empty().text(""),$("#level-4").empty().text("");var l={level2:null,level3:null,level4:null,requestor:approvalNames.requestor,displayname:approvalNames.displayname,to:null,cc:[],round:["lv2","lv3","lv4"]};switch(l.level4=approvalNames.level4,l.level3=approvalNames.level3,l.level2=approvalNames.level2,t.map((e=>{l.cc.push(`${e}@ap.averydennison.com`)})),e){case 4:return l.to=approvalNames.level4,l.cc.push(approvalNames.level3),l.cc.push(approvalNames.requestor),$("#level-3").empty().text(approvalNames.level3),$("#level-4").empty().text(approvalNames.level4),""!=approvalNames.level2?(l.cc.push(approvalNames.level2),$("#level-2").empty().text(approvalNames.level2)):(-1!==l.round.indexOf("lv2")&&l.round.splice(l.round.indexOf("lv2"),1),l.level2=""),l;case 3:return l.to=approvalNames.level3,l.cc.push(approvalNames.requestor),$("#level-3").empty().text(approvalNames.level3),-1!==l.round.indexOf("lv4")&&(l.round.splice(l.round.indexOf("lv4"),1),l.level4=""),""==approvalNames.level2?(-1!==l.round.indexOf("lv2")&&l.round.splice(l.round.indexOf("lv2"),1),l.level2=""):(l.cc.push(approvalNames.level2),$("#level-2").empty().text(approvalNames.level2)),l;case 2:return-1!==l.round.indexOf("lv4")&&(l.round.splice(l.round.indexOf("lv4"),1),l.level4=""),""==approvalNames.level2?(-1!==l.round.indexOf("lv2")&&(l.round.splice(l.round.indexOf("lv2"),1),l.level2=""),l.to=approvalNames.level3,l.cc.push(approvalNames.requestor),l.level2="",$("#level-3").empty().text(approvalNames.level3)):(-1!==l.round.indexOf("lv3")&&l.round.splice(l.round.indexOf("lv3"),1),l.to=approvalNames.level2,l.cc.push(approvalNames.requestor),l.level3="",$("#level-2").empty().text(approvalNames.level2)),l;default:return l.round=[""],l}}$(document).on("click","#btn-submit-glid",(async function(){var e=table.getColumnData(0).filter((e=>""!=e));e.length>0&&($(".preload").addClass("d-flex"),await promiseGetDataPX(1,1,e).then((t=>{if(!t.results)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"GLID not found",showConfirmButton:!0});{const l=[],a=t.results.filter((e=>0==e.from));a.length>0&&(a.forEach(((e,t,o)=>{let r=t;for(let l=t+1;l<a.length;++l){a[l].item==e.item&&l.id<e.id&&(r=l)}let s=a[r];l.some((e=>e.item==s.item))||l.push(s)})),console.log("filteredArrUSD:",l));const o=[],r=t.results.filter((e=>1==e.from));r.length>0&&(r.forEach(((e,t,l)=>{let a=t;for(let l=t+1;l<r.length;++l){r[l].item==e.item&&l.id<e.id&&(a=l)}let s=r[a];o.some((e=>e.item==s.item))||o.push(s)})),console.log("filteredArrVND:",o)),e.map(((e,t)=>{var a=l.filter((t=>t.item==e));a.length<=0?(table.setValueFromCoords(0,t,e,!0),table.setValueFromCoords(1,t,null,!0),table.setValueFromCoords(2,t,null,!0),table.setValueFromCoords(3,t,null,!0),table.setValueFromCoords(4,t,null,!0),table.setValueFromCoords(5,t,null,!0),table.setValueFromCoords(6,t,null,!0)):(table.setValueFromCoords(0,t,a[0].item,!0),table.setValueFromCoords(1,t,a[0].soldtoname,!0),table.setValueFromCoords(2,t,a[0].customeritem,!0),table.setValueFromCoords(3,t,a[0].productionmethod,!0),table.setValueFromCoords(4,t,a[0].makebuyer,!0),table.setValueFromCoords(5,t,a[0].pendingmaterialcost,!0),table.setValueFromCoords(6,t,a[0].price,!0),o.filter((t=>t.item==e)).length>0&&table.setValueFromCoords(7,t,o.filter((t=>t.item==e))[0].price,!0))}))}return promiseGetDataDC(1,1,e)})).then((t=>{if(t.results){console.log("discount datas:"),console.log(t.results);const l=ctCcy.value,a=`VN${$("#sl-bill-code").find("option:selected").text()}`;switch(l){case"USD":e.map(((e,l)=>{console.log(`table.getValueFromCoords(0, ${l}, false) = ${table.getValueFromCoords(0,l,!1)}`);var o=t.results.filter((t=>0==t.from&&t.oracleitem==e&&t.modifiernumber==a));if(o.length>0)if(o.filter((e=>null!=e.discountprice)).length>0){if(o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))){var r=o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate)).map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YYYY").format("DD/MMM/YYYY"),"days")));console.log("max date: ",Math.max(...r)),table.setValueFromCoords(8,l,o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))[r.indexOf(Math.max(...r))].discountprice,!0)}}else console.log("discount price null"),table.setValueFromCoords(8,l,table.getValueFromCoords(6,l,!1),!0);else console.log("glid with discountc price not found"),table.setValueFromCoords(8,l,table.getValueFromCoords(6,l,!1),!0)}));break;case"VND":e.map(((e,l)=>{console.log(`table.getValueFromCoords(0, ${l}, false) = ${e}`);var o=t.results.filter((t=>1==t.from&&t.oracleitem==e&&t.modifiernumber==a));if(o.length>0)if(o.filter((e=>null!=e.discountprice)).length>0){if(o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))){var r=o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate)).map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YY").format("DD/MM/YYYY"),"days")));console.log("max date: ",Math.max(...r)),table.setValueFromCoords(9,l,o.filter((e=>null!=e.discountprice)).filter((e=>null!=e.startdate))[r.indexOf(Math.max(...r))].discountprice,!0)}}else console.log("discount price null"),table.setValueFromCoords(9,l,table.getValueFromCoords(7,l,!1),!0);else console.log("glid with discountc price not found"),table.setValueFromCoords(9,l,table.getValueFromCoords(7,l,!1),!0)}))}}})).catch((e=>{console.log("promise err: ",e),$(".preload").removeClass("d-flex")})),calculateNeededSpecialPrice(),await new Promise(((e,t)=>{if($("#form-submit").valid()){var l=table.getJson(),a=[],o=0,r=[];if(l.map(((e,t)=>{Object.keys(e).every((t=>""==e[t]))||(e.index=t,r.push(e))})),r.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});if(!r.every((e=>e.rb==r[0].rb)))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"RB not same!",showConfirmButton:!0});if(!r.every((e=>e.makebuy==r[0].makebuy)))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/ Buy items not same!",showConfirmButton:!0});for(var s=[],n=[],i=0;i<r.length;i++){var d=0;for(var c in l[i]){if(""===l[i][c]&&[0,5,11,12,13,14].includes(d))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:c+" at row "+(i+1)+" is blank. Pls check again!",showConfirmButton:!0});d++}if("!err"==l[i].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("!err"==l[i].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("NaN"==l[i].neededspecialprice)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Needed special price: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("NaN"==l[i].cm)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("Yes"==$("#sl-weighted-cm").val()){if("NaN"==l[i].ttlsales)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL sales: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("NaN"==l[i].ttlcost)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL Cost: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0})}if(o++,22!=Object.keys(l[i]).length)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Total table column != 22. Pls check again",showConfirmButton:!0});$("#form-submit").serializeArray().map(((e,t)=>{l[i][e.name]=e.value})),l[i].billcode=$("#sl-bill-code").find("option:selected").text(),l[i].totalttlsales=$("#total-ttlsales-val").val(),l[i].totalttlcost=$("#total-ttlcost-val").val(),l[i].totalweightedcm=$("#total-weightedcm-val").val(),-1==s.indexOf(l[i].productline)&&s.push(`"${l[i].productline}"`),-1==n.indexOf(l[i].marketsegment)&&n.push(`"${l[i].marketsegment}"`),a.push({...l[i]})}if(0==o)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){null!=e?(null==e[1]&&console.log("GPD in charge not found!"),null!=e[0]&&(console.log(e),a.map(((t,l)=>{if(null!=e[1]){var a=e[1].filter((e=>e.productline==t.productline));a.length>0&&(t.gpdincharge=a.map((e=>e.gpd)).join(";"),table.setValueFromCoords(16,t.index,t.gpdincharge,!0))}var o=e[0].filter((e=>e.productline==t.productline&&e.rb==t.rb&&e.marketsegment==t.marketsegment&&e.mincm<=t.cm&&e.maxcm>=t.cm));o.length>0&&(t.approvallevel=o[0].level,table.setValueFromCoords(15,t.index,o[0].level,!0))})),console.log(a),$("#btn-submit").show(),$("#btn-submit-glid").hide(),$(".preload").removeClass("d-flex"))):($(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:l.msg,showConfirmButton:!0}))})).GetApprovalAndGPDData(a[0].makebuy,a[0].rb,s.join(","),n.join(","),a[0].tcnsite)}else $(".preload").removeClass("d-flex")})).then((()=>{console.log("promisePreviewData finished")})))})),frm=$("#form-submit").serialize(),$(document).on("click","#btn-submit",(function(){if($("#form-submit").valid()){var e=table.getJson();if($("#form-submit").serialize()==frm)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Nothing to change! Nothing gonna change my love for u",showConfirmButton:!0});$(".preload").addClass("d-flex"),$.ajax({url:"https://script.google.com/a/macros/ap.averydennison.com/s/AKfycbw6adf8_wHxlvUFVW2lxXwqSOLxYCHq5edlnD-ADUupuAjkI72wSjnlAgrmLRlfkxiweQ/exec",dataType:"JSONP",async:!1,jsonpCallback:"callback",type:"GET",success:async function(t){token=t,console.log(token);var l=[],a={time:moment(new Date).format("hh:mm:ss A"),requestor:null,date:moment(new Date).format("DD-MMM-YYYY"),tcnno:"this is tcn no"},o=0,r=[];if(e.map(((e,t)=>{Object.keys(e).every((t=>""==e[t]))||(e.index=t,r.push(e))})),r.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});if(!r.every((e=>e.rb==r[0].rb)))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"RB not same!",showConfirmButton:!0});if(!r.every((e=>e.makebuy==r[0].makebuy)))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/ Buy items not same!",showConfirmButton:!0});var s=[];s="Yes"==$("#sl-weighted-cm").val()?columnvalidateYes:columnvalidateNo;for(var n=0;n<r.length;n++){var i=0;for(var d in e[n]){if(""===e[n][d]&&s.includes(i))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:d+" at row "+(n+1)+" is blank. Pls check again!",showConfirmButton:!0});i++}if("!err"==e[n].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(n+1)+". Pls check again",showConfirmButton:!0});if("!err"==e[n].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(n+1)+". Pls check again",showConfirmButton:!0});if("NaN"==e[n].neededspecialprice)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Needed special price: Invalid value at row: "+(n+1)+". Pls check again",showConfirmButton:!0});if("NaN"==e[n].cm)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM: Invalid value at row: "+(n+1)+". Pls check again",showConfirmButton:!0});if("Yes"==$("#sl-weighted-cm").val()){if("NaN"==e[n].ttlsales)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL sales: Invalid value at row: "+(n+1)+". Pls check again",showConfirmButton:!0});if("NaN"==e[n].ttlcost)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL Cost: Invalid value at row: "+(n+1)+". Pls check again",showConfirmButton:!0})}if(o++,22!=Object.keys(e[n]).length)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Total table column != 21. Pls check again",showConfirmButton:!0});$("#form-submit").serializeArray().map(((t,l)=>{e[n][t.name]=t.value})),e[n].billcode=$("#sl-bill-code").find("option:selected").text(),e[n].totalttlsales=$("#total-ttlsales-val").val(),e[n].totalttlcost=$("#total-ttlcost-val").val(),e[n].totalweightedcm=$("#total-weightedcm-val").val(),l.push({...a,...e[n]})}if(0==o)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});console.log(l);var c=[],u=0;table.getColumnData(16).filter((e=>""!=e)).length>0&&table.getColumnData(16).filter((e=>""!=e)).map((e=>{e.split(";").map((e=>{-1==c.indexOf(e)&&c.push(e)}))})),table.getColumnData(15).filter((e=>""!=e)).length>0&&table.getColumnData(15).filter((e=>""!=e)).map((e=>{var t=e.replace(/\D+/g,"");""==t?t=0:parseInt(t)>u&&(u=parseInt(t))}));var m=findUserRef(u,c);console.log(m),google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){$(".preload").removeClass("d-flex"),e.suc?Swal.fire({icon:"success",title:"Done! Email has sent",showConfirmButton:!0}):Swal.fire({icon:"error",title:e.msg,showConfirmButton:!0})})).AddNew(l,m,token)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error get token"),Swal.fire({icon:"error",title:"Error while get token",showConfirmButton:!0})}})}else Swal.fire({icon:"error",title:"Form is invalid!",showConfirmButton:!0})})),$(document).on("click","#btn-add-row",(()=>{insertRow()}));