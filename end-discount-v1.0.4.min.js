$(".preload").addClass("d-flex");const _siteNameSheetInit="PX";var _requestType="End Discount",_exchangeRateValue=24567,_minExchangeRateValue=23500,_table=null,_approvalNames={};const _columnvalidateEndDiscount=[0,1,2,3,4,5,6,7,8,13,14,15,16,17],_declareData=(e,t)=>Array.from({length:e},((e,l)=>Array.from({length:t},((e,t)=>null)))),_declareSingleData=e=>Array.from({length:e},((e,t)=>null)),_mapCurrencyValueInFT=(e,t)=>{if(0==e)switch(t){case"USD":return 5;case"VND":return 6;default:return-1}switch(t){case"USD":return 7;case"VND":return 8;default:return-1}},_mapSiteValueInFT=e=>{switch(e){case"FRU":return 1;case"KHT":return 2;case"KHM":return 3;default:return 0}};async function saveAsExcel(){if(null!=_table){let e=_table.getJson().filter((e=>""!=e.glid&&null!=e.glid&&null!=e.glid));if(e.length>0){const t=new ExcelJS.Workbook,l=t.addWorksheet();l.addRow(["Request Type","Site","Bill-to Name","GLID","Currency","Sold To Name","Customer Item","Production Method","Make/Buy","Cost","Std price(USD)","Std price(VND)","Current special price(USD)","Current special price(VND)","Effective Date","RB","Production","Market Segment","GPD in charge & Carbon Copy","Start Date"]).font={bold:!0},e.map((e=>{l.addRow([_requestType,$("#sl-site").val(),e.billtoname,e.glid,e.currency,e.soldtoname,e.customeritem,e.productionmethod,e.makebuy,e.cost,e.stdpriceusd,e.stdpricevnd,e.currentspecialpriceusd,e.currentspecialpricevnd,e.effectivedate,e.rb,e.productline,e.marketsegment,e.gpdincharge,e.startdate])}));const a=await t.xlsx.writeBuffer();saveAs(new Blob([a]),"tucana-end-discount-export.xlsx")}}}const _promiseGetDataPX=(e,t,l)=>new Promise(((a,r)=>{$.ajax({url:"https://d0rvnm2z1470004/tucana/search",dataType:"JSON",async:!1,type:"post",data:{itemtype:t,site:e,glids:l},success:function(e){a(e)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error"),r()}})})),_promiseGetDataDC=(e,t,l)=>new Promise(((a,r)=>{$.ajax({url:"https://d0rvnm2z1470004/tucana/search",dataType:"JSON",async:!1,type:"post",data:{itemtype:t,site:e,glids:l},success:function(e){a(e)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error"),r()}})})),_promisePreviewData=()=>new Promise(((e,t)=>{if($("#form-submit").valid()){var l=_table.getJson(),a=[],r=0,n=[];if(l.map(((e,t)=>{Object.keys(e).every((t=>""==e[t]))||(e.index=t,n.push(e))})),console.log("filtered: ",n),n.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});for(var o=[],i=0;i<n.length;i++){var s=0;for(var u in l[i]){if(""===l[i][u]&&[0,1,8,14,15,16].includes(s))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:u+" at row "+(i+1)+" is blank. Pls check again!",showConfirmButton:!0});s++}if("!err"==l[i].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});if("!err"==l[i].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(i+1)+". Pls check again",showConfirmButton:!0});r++,$("#form-submit").serializeArray().map(((e,t)=>{l[i][e.name]=e.value})),o.push({productline:l[i].productline,marketsegments:l[i].marketsegment,makebuy:l[i].makebuy,rb:l[i].rb}),a.push({...l[i]})}if(0==r)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){console.log("res"),console.log(e),null!=e&&null!=e?(console.log("res"),console.log(e),e[0].length>0&&(a.map(((t,l)=>{if(console.log("VALUE"),console.log(t),"Make"==t.makebuy){let a=e[2].filter((e=>e.productline==t.productline));a.length>0&&(t.gpdincharge=a.map((e=>e.gpd)).join(";"),_table.ignoreEvents=!0,_table.setValue(`R${l+1}`,t.gpdincharge,!0),_table.ignoreEvents=!1)}else{let a=e[3].filter((e=>e.productline==t.productline));console.log("BUY"),console.log(a),a.length>0&&(t.gpdincharge=a.map((e=>e.gpd)).join(";"),_table.ignoreEvents=!0,_table.setValue(`R${l+1}`,t.gpdincharge,!0),_table.ignoreEvents=!1)}})),console.log("arr: ",a),$("#btn-submit").show(),$("#btn-submit-glid").hide(),$(".preload").removeClass("d-flex"))):($(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:l.msg,showConfirmButton:!0}))})).GetApprovalAndGPDData(o,a[0].tcnsite)}else $(".preload").removeClass("d-flex")}));function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("movetop").style.display="block":document.getElementById("movetop").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}function formatAsPercent(e){return new Intl.NumberFormat("default",{style:"percent",minimumFractionDigits:0,maximumFractionDigits:0}).format(e/100)}function getDataFail(e){$(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:"Error! Pls try again",showConfirmButton:!0})}function insertRow(){let e=Number(document.getElementById("txt-row").value);for(let t=0;t<e;t++)_table.insertRow(_declareSingleData(19))}function userData(e){null==e&&Swal.fire({icon:"error",title:"Error! Cannot get username",showConfirmButton:!0}),$("#requestor").empty().text(e.displayname),_approvalNames=e}function renderDuplicateRow(e){return e.map((e=>`<p>GLID: ${e[2]} - Bill to code: ${e[1]} already exist in <a href="javascript:void(0);">database</a>, request Id: ${e[0]}</p>`)).join("</br>")}window.onscroll=function(){scrollFunction()},$(document).on("click","#btn-export",(async function(){await saveAsExcel()})),google.script.run.withFailureHandler(getDataFail).withSuccessHandler((e=>{if(console.log("res"),console.log(e),_exchangeRateValue=parseInt(e.exchangerate),_minExchangeRateValue=parseInt(e.minExchangerate),null==e.users)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"You do not have permission to access this page! Please contact to sales admin",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1});_table=jspreadsheet(document.getElementById("spreadsheet"),{data:_declareData(100,19),tableOverflow:!0,allowDeleteColumn:!1,allowManualInsertColumn:!1,autoIncrement:!1,allowInsertColumn:!1,rowResize:!0,columns:[{type:"dropdown",title:"Bill-to Name",width:"180",id:"required",name:"billtoname",autocomplete:!0,source:e.billtocode.filter((e=>"LH"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency}))),filter:function(t,l,a,r,n){switch($("#sl-site").val()){case"LH":return e.billtocode.filter((e=>"LH"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));case"FRU":return e.billtocode.filter((e=>"FRU"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));case"KHT":return e.billtocode.filter((e=>"KHT"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));case"KHM":return e.billtocode.filter((e=>"KHM"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));default:return n}}},{type:"text",title:"GLID",width:"150",name:"glid",id:"required",readOnly:!1},{type:"hidden",title:"Bill-to Code",width:"150",id:"readonly",name:"billtocode",readOnly:!0},{type:"text",title:"Currency",width:"150",id:"readonly",name:"currency",readOnly:!0},{type:"text",title:"Sold To Name",width:"150",id:"readonly",name:"soldtoname",readOnly:!0},{type:"text",title:"Customer Item",width:"150",name:"customeritem",id:"readonly",readOnly:!0},{type:"text",title:"Production Method",width:"150",id:"readonly",name:"productionmethod",readOnly:!0},{type:"dropdown",title:"Make/Buy",width:"120",name:"makebuy",id:"readonly",source:["Make","Buy"],readOnly:!0},{type:"text",title:"Cost",width:"100",name:"cost",id:"readonly",readOnly:!0},{type:"number",title:"Std price\n(USD)",width:"120",id:"readonly",name:"stdpriceusd",readOnly:!0},{type:"number",title:"Std price\n(VND)",width:"80",name:"stdpricevnd",id:"readonly",readOnly:!0},{type:"number",title:"Current special price\n(USD)",width:"160",name:"currentspecialpriceusd",id:"readonly",readOnly:!0},{type:"number",title:"Current special price\n(VND)",width:"160",name:"currentspecialpricevnd",id:"readonly",readOnly:!0},{type:"calendar",title:"Effective Date",width:"150",name:"effectivedate",id:"required",options:{format:"DD/Mon/YYYY"}},{type:"dropdown",title:"RB",width:"150",id:"required",name:"rb",autocomplete:!0,source:e.rbos},{type:"dropdown",title:"Production",width:"180",id:"required",name:"productline",autocomplete:!0,source:e.plmake.concat(e.plbuy),filter:function(t,l,a,r,n){switch(t.jspreadsheet.getValueFromCoords(4,r,!1)){case"Make":return e.plmake;case"Buy":return e.plbuy;default:return e.plmake.concat(e.plbuy)}}},{type:"dropdown",title:"Market Segment",width:"180",id:"required",name:"marketsegment",autocomplete:!0,readOnly:!1,source:e.markets},{type:"dropdown",title:"GPD in charge & Carbon Copy",width:"240",name:"gpdincharge",autocomplete:!0,readOnly:!1,source:e.gpd,multiple:!0},{type:"text",title:"Start Date",width:"100",name:"startdate",id:"readonly",readOnly:!0}],onbeforechange:function(t,l,a,r,n){switch(Number(a)){case 0:if(_table.ignoreEvents=!0,_table.getCell(`I${Number(r)+1}`).classList.add("readonly"),""!=n&&null!=n&&null!=n){let t=n.split(" ")[0],l=e.billtocode.find((e=>e.site==$("#sl-site").val()&&e.btoCode==t.trim()));_table.setValue(`C${Number(r)+1}`,t,!0),_table.setValue(`D${Number(r)+1}`,null==l||null==l?null:l.curency,!0)}else _table.setValue(`C${Number(r)+1}`,null,!0),_table.setValue(`D${Number(r)+1}`,null,!0);_table.ignoreEvents=!1;break;case 1:_table.ignoreEvents=!0,_table.getCell(`I${Number(r)+1}`).classList.add("readonly"),_table.ignoreEvents=!1;break;case 8:_table.ignoreEvents=!0,_table.setValue(`I${Number(r)+1}`,n,!0),_table.ignoreEvents=!1;break;case 14:_table.ignoreEvents=!0;const t=e.lkrbms.filter((e=>{if(e[0]==n)return e[1]}));0!=t.length?(_table.setValue(`Q${Number(r)+1}`,t[0][1],!0),_table.getCell(`Q${Number(r)+1}`).style.border=""):(_table.setValue(`Q${Number(r)+1}`,null,!0),_table.getCell(`Q${Number(r)+1}`).style.border="0.5px solid red"),_table.ignoreEvents=!1;break;default:return n}},onchange:function(e,t,l,a,r,n){switch(Number(l)){case 0:case 1:case 8:case 14:case 15:case 16:n!=r&&($("#btn-submit-glid").show(),$("#btn-submit").hide());break;case 7:r!=n&&_table.setValue(`Q${Number(a)+1}`,null,!0)}},onpaste(e,t){if(!(t[0].length>19))return t;Swal.fire({icon:"error",title:"Value you just pasted is longer than the length of the _table. Do not submit! Pls check again",showConfirmButton:!0})}}),userData(e.users),$(".preload").removeClass("d-flex")})).getInitalDataAsync("PX"),$(document).on("click","#btn-submit-glid",(async function(){var e=_table.getJson();let t=[];if(e.map(((e,l)=>{""==e.glid||null==e.glid||null==e.glid?_table.deleteRow(l):t.push({glid:e.glid,billtocode:e.billtocode})})),t.length>0){let l=e.map((e=>e.currency)).filter((e=>""!=e)),a=[...new Set(l)];if(1!=a.length)return void Swal.fire({icon:"error",title:"Do not submit multiple currency values at same time! Pls check the Currency column again",showConfirmButton:!0});const r=t.reduce(((e,t)=>((objectFound=e.find((e=>e.glid===t.glid&&e.billtocode===t.billtocode)))?objectFound.times++:(t.times=1,e.push(t)),e)),[]);if(r.filter((e=>e.times>1)).length>0){let e=r.filter((e=>e.times>1));return void Swal.fire({icon:"error",title:`GLID: ${e[0].glid}, bill to code: ${e[0].billtocode} is duplicated ${e[0].times-1} time${e[0].times-1>1?"s":""}.`,showConfirmButton:!0})}$(".preload").addClass("d-flex");let n=_mapCurrencyValueInFT(0,a[0]),o=_mapSiteValueInFT($("#sl-site").val());await _promiseGetDataPX(o,["5","6"],t.map((e=>e.glid))).then((e=>e.results?(console.log("px data.results"),console.log(e.results),_table.ignoreEvents=!0,t.map(((t,l)=>{let a=e.results.find((e=>e.glid==t.glid&&5==e.itemtype)),r=e.results.find((e=>e.glid==t.glid&&6==e.itemtype)),n=null==a||null==a?null==r||null==r?null:r:a;if(_table.setValue(`J${l+1}`,null==a||null==a?null:a.price,!0),_table.setValue(`K${l+1}`,null==r||null==r?null:r.price,!0),null==n||null==n){_table.setValue(`B${l+1}`,t.glid,!0),_table.setValue(`E${l+1}`,null,!0),_table.setValue(`F${l+1}`,null,!0),_table.setValue(`G${l+1}`,null,!0),_table.setValue(`H${l+1}`,null,!0),_table.getCell(`I${l+1}`).classList.contains("readonly")?_table.setValue(`I${l+1}`,null,!0):""!=_table.getValue(`I${l+1}`)&&null!=_table.getValue(`I${l+1}`)&&null!=_table.getValue(`I${l+1}`)&&0!=_table.getValue(`I${l+1}`)||_table.setValue(`I${l+1}`,null,!0),_table.getCell(`I${l+1}`).classList.remove("readonly")}else{_table.setValue(`B${l+1}`,n.glid,!0),_table.setValue(`E${l+1}`,n.rb,!0),_table.setValue(`F${l+1}`,n.itemcode,!0),_table.setValue(`G${l+1}`,n.productmethod,!0),_table.setValue(`H${l+1}`,n.source,!0),_table.getCell(`I${l+1}`).classList.contains("readonly")?_table.setValue(`I${l+1}`,n.cost,!0):""!=_table.getValue(`I${l+1}`)&&null!=_table.getValue(`I${l+1}`)&&null!=_table.getValue(`I${l+1}`)&&0!=_table.getValue(`I${l+1}`)||_table.setValue(`I${l+1}`,n.cost,!0),""!=n.cost&&null!=n.cost&&null!=n.cost&&0!=n.cost||_table.getCell(`I${l+1}`).classList.remove("readonly")}})),_table.ignoreEvents=!1,_promiseGetDataDC(o,["7","8"],t.map((e=>e.glid)))):($(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"GLID not found",showConfirmButton:!0})))).then((e=>{console.log("discount data:"),console.log(e.results),e.results&&(n=_mapCurrencyValueInFT(1,a[0]),_table.ignoreEvents=!0,t.map(((t,l)=>{let a=e.results.filter((e=>e.glid==t.glid&&e.modifiernumber==`VN${t.billtocode}`&&7==e.itemtype)),r=e.results.filter((e=>e.glid==t.glid&&e.modifiernumber==`VN${t.billtocode}`&&8==e.itemtype));if(a.length>0)if(a.filter((e=>null!=e.price)).length>0){let e=a.filter((e=>null!=e.price)).filter((e=>null!=e.startdate));if(e){let t=e.map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YYYY").format("DD/MMM/YYYY"),"days")));console.log("max date 3: ",Math.max(...t));let a=t.indexOf(Math.max(...t));_table.setValue(`L${l+1}`,e[a].price,!0),_table.setValue(`S${l+1}`,e[a].startdate,!0)}}else console.log("discount price usd null"),_table.setValue(`L${l+1}`,null,!0),_table.setValue(`S${l+1}`,null,!0);else console.log("glid with discount price usd not found"),_table.setValue(`L${l+1}`,null,!0),_table.setValue(`S${l+1}`,null,!0);if(r.length>0)if(r.filter((e=>null!=e.price)).length>0){let e=r.filter((e=>null!=e.price)).filter((e=>null!=e.startdate));if(e){let t=e.map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YYYY").format("DD/MMM/YYYY"),"days")));console.log("max date 3: ",Math.max(...t));let a=t.indexOf(Math.max(...t));_table.setValue(`M${l+1}`,e[a].price,!0),""!=_table.getValue(`L${l+1}`)&&null!=_table.getValue(`L${l+1}`)&&null!=_table.getValue(`L${l+1}`)||_table.setValue(`S${l+1}`,e[a].startdate,!0)}}else console.log("discount price VND null"),_table.setValue(`M${l+1}`,null,!0),""!=_table.getValue(`L${l+1}`)&&null!=_table.getValue(`L${l+1}`)&&null!=_table.getValue(`L${l+1}`)||_table.setValue(`S${l+1}`,null,!0);else console.log("glid with discount price VND not found"),_table.setValue(`M${l+1}`,null,!0),""!=_table.getValue(`L${l+1}`)&&null!=_table.getValue(`L${l+1}`)&&null!=_table.getValue(`L${l+1}`)||_table.setValue(`S${l+1}`,null,!0)})),_table.ignoreEvents=!1)})).catch((e=>{console.log("promise err: ",e),$(".preload").removeClass("d-flex")})),await _promisePreviewData().then((()=>{console.log("_promisePreviewData finished")}))}})),$(document).on("click","#btn-submit",(function(){if($("#form-submit").valid()){var e=_table.getJson();$(".preload").addClass("d-flex"),$.ajax({url:"https://script.google.com/a/macros/ap.averydennison.com/s/AKfycbzZXbC2NZpDCQxwiyxYKZLPDu-0YPU19OL8YjvxoSgiloaj0wbCmhFSvcR2a_g-MgFE/exec",dataType:"JSONP",async:!1,jsonpCallback:"callback",type:"GET",success:async function(t){token=t,console.log(token);var l=[],a={time:moment(new Date).format("hh:mm:ss A"),requestor:null,date:moment(new Date).format("DD-MMM-YYYY"),tcnno:"this is tcn no"},r=0,n=[];if(e.map(((e,t)=>{Object.keys(e).every((t=>""==e[t]))||(e.index=t,n.push(e))})),n.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});for(var o=0;o<n.length;o++){var i=0;for(var s in e[o]){if(""===e[o][s]&&_columnvalidateEndDiscount.includes(i))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:s+" at row "+(o+1)+" is blank. Pls check again!",showConfirmButton:!0});i++}if(""==e[o].gpdincharge||null==e[o].gpdincharge||null==e[o].gpdincharge)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"GPD in charge column: Invalid value at row: "+(o+1)+". Pls check again",showConfirmButton:!0});if("!err"==e[o].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(o+1)+". Pls check again",showConfirmButton:!0});if("!err"==e[o].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(o+1)+". Pls check again",showConfirmButton:!0});r++,$("#form-submit").serializeArray().map(((t,l)=>{e[o][t.name]=t.value})),e[o].requestorremark=$("#remark_requestor").val(),e[o].requesttype=_requestType,e[o].effectivedate=null==e[o].effectivedate||""===e[o].effectivedate||null==e[o].effectivedate?null:moment(e[o].effectivedate).format("DD/MMM/YYYY"),l.push({...a,...e[o]})}if(0==r)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});var u=[];let d=_table.getColumnData(17).filter((e=>""!=e&&null!=e&&null!=e));d.length>0&&d.map((e=>{e.split(";").map((e=>{""!=e&&u.push(e)}))})),(u=[...new Set(u)].filter((e=>""!=e)).map((e=>`${e}@ap.averydennison.com`))).push("gpdvn_record@ap.averydennison.com"),u.push("rbis.vn.gpd.admin@ap.averydennison.com");let c={requestor:_approvalNames.requestor,displayname:_approvalNames.displayname,gpd:u};console.log("arr2417: ",l),google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){null==e?google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){$(".preload").removeClass("d-flex"),e.suc?Swal.fire({icon:"success",title:"Done! Email has sent",showConfirmButton:!0}):Swal.fire({icon:"error",title:e.msg,showConfirmButton:!0})})).AddNewEndDiscount(l,c,token):Swal.fire({title:"Warning",icon:"warning",html:renderDuplicateRow(e),confirmButtonText:"OK",allowOutsideClick:!1}).then((e=>{e.isConfirmed,$(".preload").removeClass("d-flex")}))})).checkDuplicateEndDiscount(l.map((e=>({billtocode:e.billtocode,glid:e.glid,requesttype:e.requesttype}))))},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error get token"),Swal.fire({icon:"error",title:"Error while get token",showConfirmButton:!0})}})}else Swal.fire({icon:"error",title:"Form is invalid!",showConfirmButton:!0})})),$(document).on("click","#btn-add-row",(()=>{insertRow()}));