$(".preload").addClass("d-flex");var _neeededSpecialPriceRound=5;const _siteNameSheetInit="PX";var _requestType="New Request",_exchangeRateValue=24567,_minExchangeRateValue=23500,_table=null,_approvalNames={};const _columnvalidateYes=[0,1,2,3,4,5,6,7,8,10,11,17,18,19,22,23,24,25,26,27],_columnvalidateNo=[0,1,2,3,4,5,6,7,8,10,11,17,18,19,22,23,24,25,26],_slWC=document.getElementById("sl-weighted-cm"),_inRBrebate=document.querySelector(".js-rb-rebate"),_declareData=(e,l)=>Array.from({length:e},((e,t)=>{let a=Array.from({length:l},((e,l)=>null));return a[13]="Yes",a[15]="Yes",a[16]=_exchangeRateValue,a})),_declareSingleData=e=>{let l=Array.from({length:e},((e,l)=>null));return l[13]="Yes",l[15]="Yes",l[16]=_exchangeRateValue,l},_mapCurrencyValueInFT=(e,l)=>{if(0==e)switch(l){case"USD":return 5;case"VND":return 6;default:return-1}switch(l){case"USD":return 7;case"VND":return 8;default:return-1}},_mapSiteValueInFT=e=>{switch(e){case"FRU":return 1;case"KHT":return 2;case"KHM":return 3;default:return 0}};async function saveAsExcel(){if(null!=_table){let e=_table.getJson().filter((e=>""!=e.glid&&null!=e.glid&&null!=e.glid));if(e.length>0){const l=new ExcelJS.Workbook,t=l.addWorksheet();t.addRow(["Request Type","Site","RB rebate","Weighted CM (Y/N)","YTD Total Sale ($)","YTD Total Discount ($)","Bill-to Name","GLID","Currency","Sold To Name","Customer Item","Production Method","Make/Buy","Cost","Std price(USD)","Std price(VND)","Current special price(USD)","Current special price(VND)","D2D price","Freight fee","Different exchange rate","Exchange rate","Needed special price","CM","Effective Date","End Date","Season","RB","Production","Market Segment","Approval level","GPD in charge & Carbon Copy","TTL Sales QTY","TTL Produced QTY","TTL sales","TTL cost"]).font={bold:!0},e.map((e=>{t.addRow([_requestType,$("#sl-site").val(),$('input[name="rbrebate"]').val(),$("#sl-weighted-cm").val(),$("#ytd-sale").val(),$("#ytd-discount").val(),e.billtoname,e.glid,e.currency,e.soldtoname,e.customeritem,e.productionmethod,e.makebuy,e.cost,e.stdpriceusd,e.stdpricevnd,e.currentspecialpriceusd,e.currentspecialpricevnd,e.d2dprice,e.freightfee,e.differentexchangerate,e.exchangerate,e.neededspecialprice,e.cm,e.effectivedate,e.enddate,e.season,e.rb,e.productline,e.marketsegment,e.approvallevel,e.gpdincharge,e.ttlsalesqty,e.ttlproducedqty,e.ttlsales,e.ttlcost])}));const a=await l.xlsx.writeBuffer();saveAs(new Blob([a]),"tucana-export.xlsx")}}}const _setNeededSpecialPriceRoundTo=e=>{_neeededSpecialPriceRound=Number(e),_table.ignoreEvents=!0;for(let e=0;e<_table.getJson().length;e++)""!=_table.getValue(`D${e+1}`)&&null!=_table.getValue(`D${e+1}`)&&null!=_table.getValue(`D${e+1}`)&&calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${e+1}`)),e+1);_table.ignoreEvents=!1},_promiseGetDataPX=(e,l,t)=>new Promise(((a,r)=>{$.ajax({url:"https://d0rvnm2z1470004/tucana/search",dataType:"JSON",async:!1,type:"post",data:{itemtype:l,site:e,glids:t},success:function(e){a(e)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error"),r()}})})),_promiseGetDataDC=(e,l,t)=>new Promise(((a,r)=>{$.ajax({url:"https://d0rvnm2z1470004/tucana/search",dataType:"JSON",async:!1,type:"post",data:{itemtype:l,site:e,glids:t},success:function(e){a(e)},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error"),r()}})})),_promisePreviewData=()=>new Promise(((e,l)=>{if($("#form-submit").valid()){var t=_table.getJson(),a=[],r=0,o=[];if(t.map(((e,l)=>{Object.keys(e).every((l=>""==e[l]))||(e.index=l,o.push(e))})),console.log("filtered: ",o),o.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});for(var n=[],u=0;u<o.length;u++){var i=0;for(var s in t[u]){if(""===t[u][s]&&[0,1,8,18,22,23,24,19].includes(i))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:s+" at row "+(u+1)+" is blank. Pls check again!",showConfirmButton:!0});i++}if(Number(t[u].freightfee)<0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Freight fee column: Do not input negative value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if(Number(t[u].exchangerate)<0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Exchange rate column: Do not input negative value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if(Number(t[u].cm)<0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM column: Do not input negative value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("!err"==t[u].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("!err"==t[u].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("NaN"==t[u].neededspecialprice)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Needed special price: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("NaN"==t[u].cm)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("Yes"==$("#sl-weighted-cm").val()){if("NaN"==t[u].ttlsales)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL sales: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("NaN"==t[u].ttlcost)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL Cost: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0})}r++,$("#form-submit").serializeArray().map(((e,l)=>{t[u][e.name]=e.value})),t[u].totalttlsales=$("#total-ttlsales-val").val(),t[u].totalttlcost=$("#total-ttlcost-val").val(),t[u].totalweightedcm=$("#total-weightedcm-val").val(),n.push({productline:t[u].productline,marketsegments:t[u].marketsegment,makebuy:t[u].makebuy,rb:t[u].rb}),a.push({...t[u]})}if(0==r)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){console.log("res"),console.log(e),null!=e&&null!=e?(console.log("res"),console.log(e),e[0].length>0&&(a.map(((l,t)=>{if(console.log("VALUE"),console.log(l),"Make"==l.makebuy){let a=e[2].filter((e=>e.productline==l.productline));a.length>0&&(l.gpdincharge=a.map((e=>e.gpd)).join(";"),_table.ignoreEvents=!0,_table.setValue(`AA${t+1}`,l.gpdincharge,!0),_table.ignoreEvents=!1);let r=e[0].find((e=>e.productline==l.productline&&e.rb==l.rb&&e.marketsegment==l.marketsegment&&e.mincm<=l.cm&&e.maxcm>=l.cm));null!=r&&null!=r&&(l.approvallevel=r.level,console.log("itemFilter.level: ",r.level),_table.ignoreEvents=!0,_table.setValue(`Z${t+1}`,r.level,!0),calculateApprovalLevelEachRow(t+1),_table.ignoreEvents=!1)}else{let a=e[3].filter((e=>e.productline==l.productline));console.log("BUY"),console.log(a),a.length>0&&(l.gpdincharge=a.map((e=>e.gpd)).join(";"),_table.ignoreEvents=!0,_table.setValue(`AA${t+1}`,l.gpdincharge,!0),_table.ignoreEvents=!1);let r=e[1].find((e=>e.productline==l.productline&&e.rb==l.rb&&e.marketsegment==l.marketsegment&&e.mincm<=l.cm&&e.maxcm>=l.cm));null!=r&&null!=r&&(l.approvallevel=r.level,console.log("itemFilter.level: ",r.level),_table.ignoreEvents=!0,_table.setValue(`Z${t+1}`,r.level,!0),calculateApprovalLevelEachRow(t+1),_table.ignoreEvents=!1)}})),console.log("arr: ",a),$("#btn-submit").show(),$("#btn-submit-glid").hide(),$(".preload").removeClass("d-flex"))):($(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:t.msg,showConfirmButton:!0}))})).GetApprovalAndGPDData(n,a[0].tcnsite)}else $(".preload").removeClass("d-flex")}));function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("movetop").style.display="block":document.getElementById("movetop").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}function calculateNeededSpecialPriceEachRow(e,l){switch(e){case 5:case 7:if("No"==_table.getValue(`N${l}`)){if(""!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`))if(_table.getCell(`R${l}`).classList.remove("readonly"),""!=_table.getValue(`R${l}`)&&null!=_table.getValue(`R${l}`)&&null!=_table.getValue(`R${l}`)){_table.setValue(`R${l}`,_table.getValue(`R${l}`),!0);try{calculateCM(l)}catch{}}else _table.setValue(`R${l}`,"freetext",!0),_table.setValue(`S${l}`,null,!0)}else if(_table.getCell(`R${l}`).classList.add("readonly"),""!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&""!=_table.getValue(`J${l}`)&&null!=_table.getValue(`J${l}`)&&null!=_table.getValue(`J${l}`)&&""!=_table.getValue(`O${l}`)&&null!=_table.getValue(`O${l}`)&&null!=_table.getValue(`O${l}`))try{_table.setValue(`R${l}`,(parseFloat(_table.getValue(`J${l}`))+parseFloat(_table.getValue(`O${l}`))).toFixed(_neeededSpecialPriceRound),!0),calculateCM(l)}catch{return}break;default:if("No"==_table.getValue(`N${l}`)){if("No"==_table.getValue(`P${l}`)){if(""!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`))if(_table.getCell(`R${l}`).classList.remove("readonly"),""!=_table.getValue(`R${l}`)&&null!=_table.getValue(`R${l}`)&&null!=_table.getValue(`R${l}`)){_table.setValue(`R${l}`,_table.getValue(`R${l}`),!0);try{calculateCM(l)}catch{}}else _table.setValue(`R${l}`,"freetext",!0),_table.setValue(`S${l}`,null,!0)}else if(_table.getCell(`R${l}`).classList.add("readonly"),""!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&""!=_table.getValue(`J${l}`)&&null!=_table.getValue(`J${l}`)&&null!=_table.getValue(`J${l}`)&&""!=_table.getValue(`Q${l}`)&&null!=_table.getValue(`Q${l}`)&&null!=_table.getValue(`Q${l}`))try{_table.setValue(`R${l}`,Math.round(parseFloat(_table.getValue(`J${l}`))*parseFloat(_table.getValue(`Q${l}`))),!0),calculateCM(l)}catch{return}}else if("No"==_table.getValue(`P${l}`)){if(_table.getCell(`R${l}`).classList.add("readonly"),""!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&""!=_table.getValue(`K${l}`)&&null!=_table.getValue(`K${l}`)&&null!=_table.getValue(`K${l}`)&&""!=_table.getValue(`O${l}`)&&null!=_table.getValue(`O${l}`)&&null!=_table.getValue(`O${l}`))try{_table.setValue(`R${l}`,Math.round(parseFloat(_table.getValue(`K${l}`))+parseFloat(_table.getValue(`O${l}`))),!0),calculateCM(l)}catch{return}}else if(_table.getCell(`R${l}`).classList.add("readonly"),""!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&null!=_table.getValue(`B${l}`)&&""!=_table.getValue(`J${l}`)&&null!=_table.getValue(`J${l}`)&&null!=_table.getValue(`J${l}`)&&""!=_table.getValue(`Q${l}`)&&null!=_table.getValue(`Q${l}`)&&null!=_table.getValue(`Q${l}`)&&""!=_table.getValue(`O${l}`)&&null!=_table.getValue(`O${l}`)&&null!=_table.getValue(`O${l}`))try{_table.setValue(`R${l}`,Math.round(parseFloat(_table.getValue(`J${l}`))*parseFloat(_table.getValue(`Q${l}`))+parseFloat(_table.getValue(`O${l}`))),!0),calculateCM(l)}catch{return}}}function calculateApprovalLevelEachRow(e){if(""!==_table.getValue(`B${e}`)&&null!==_table.getValue(`B${e}`)&&void 0!==_table.getValue(`B${e}`)&&""!==_table.getValue(`Q${e}`)&&null!==_table.getValue(`Q${e}`)&&void 0!==_table.getValue(`Q${e}`))try{if(Number(_table.getValue(`Q${e}`))<_minExchangeRateValue)return void _table.setValue(`Z${e}`,"Level 2",!0)}catch{}if("USD"==_table.getValue(`D${e}`))if("No"==_table.getValue(`N${e}`)){if("Yes"==_table.getValue(`P${e}`))return void _table.setValue(`Z${e}`,"No need to get approval",!0);if(""!==_table.getValue(`B${e}`)&&null!==_table.getValue(`B${e}`)&&void 0!==_table.getValue(`B${e}`)&&(parseFloat(_table.getValue(`R${e}`))>=parseFloat(_table.getValue(`L${e}`))||parseFloat(_table.getValue(`R${e}`))>=parseFloat(_table.getValue(`J${e}`))))return void _table.setValue(`Z${e}`,"No need to get approval",!0)}else""!==_table.getValue(`B${e}`)&&null!==_table.getValue(`B${e}`)&&void 0!==_table.getValue(`B${e}`)&&_table.setValue(`Z${e}`,"No need to get approval",!0);else if("No"==_table.getValue(`N${e}`)){if("No"==_table.getValue(`P${e}`)){if(""!==_table.getValue(`B${e}`)&&null!==_table.getValue(`B${e}`)&&void 0!==_table.getValue(`B${e}`)&&(parseFloat(_table.getValue(`R${e}`))>=parseFloat(_table.getValue(`M${e}`))||parseFloat(_table.getValue(`R${e}`))>=parseFloat(_table.getValue(`K${e}`))))return void _table.setValue(`Z${e}`,"No need to get approval",!0)}else if(""!==_table.getValue(`B${e}`)&&null!==_table.getValue(`B${e}`)&&void 0!==_table.getValue(`B${e}`))return void _table.setValue(`Z${e}`,"No need to get approval",!0)}else if(""!==_table.getValue(`B${e}`)&&null!==_table.getValue(`B${e}`)&&void 0!==_table.getValue(`B${e}`))return void _table.setValue(`Z${e}`,"No need to get approval",!0)}function calculateCM(e){console.log("calculate cm"),"VND"==_table.getValue(`D${e}`)?(""!=_table.getValue(`Q${e}`)&&null!=_table.getValue(`Q${e}`)&&null!=_table.getValue(`Q${e}`)||_table.setValue(`Q${e}`,_exchangeRateValue,!0),""!=_table.getValue(`B${e}`)&&null!=_table.getValue(`B${e}`)&&null!=_table.getValue(`B${e}`)&&(""!=$(".js-rb-rebate").val()&&null!=$(".js-rb-rebate").val()&&null!=$(".js-rb-rebate").val()?_table.setValue(`S${e}`,(100*parseFloat((parseFloat(_table.getValue(`R${e}`))*(1-parseFloat($(".js-rb-rebate").val())/100)-parseFloat(_table.getValue(`I${e}`))*parseFloat(_table.getValue(`Q${e}`)))/(parseFloat(_table.getValue(`R${e}`))*(1-parseFloat($(".js-rb-rebate").val())/100)))).toFixed(0),!0):_table.setValue(`S${e}`,(100*parseFloat((parseFloat(_table.getValue(`R${e}`))-parseFloat(_table.getValue(`I${e}`))*parseFloat(_table.getValue(`Q${e}`)))/parseFloat(_table.getValue(`R${e}`)))).toFixed(0),!0))):""!=_table.getValue(`B${e}`)&&null!=_table.getValue(`B${e}`)&&null!=_table.getValue(`B${e}`)&&(""!=$(".js-rb-rebate").val()&&null!=$(".js-rb-rebate").val()&&null!=$(".js-rb-rebate").val()?_table.setValue(`S${e}`,(100*parseFloat((parseFloat(_table.getValue(`R${e}`))*(1-parseFloat($(".js-rb-rebate").val())/100)-parseFloat(_table.getValue(`I${e}`)))/(parseFloat(_table.getValue(`R${e}`))*(1-parseFloat($(".js-rb-rebate").val())/100)))).toFixed(0),!0):_table.setValue(`S${e}`,(100*parseFloat((parseFloat(_table.getValue(`R${e}`))-parseFloat(_table.getValue(`I${e}`)))/parseFloat(_table.getValue(`R${e}`)))).toFixed(0),!0))}function calculateTotalSales(){var e=_table.getColumnData(29).filter((e=>!isNaN(e)&&isFinite(e)&&""!=e&&null!=e&&null!=e));console.log("dataColumn: ",e),e.length>0&&($("#total-ttlsales-val").val(e.reduce(((e,l)=>e+parseFloat(l)),0)),console.log("sum: ",$("#total-ttlsales-val").val()),$("#total-ttlsales").empty().text($("#total-ttlsales-val").val()),""!=$(".js-rb-rebate").val()?""!=$("#total-ttlcost-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100)-$("#total-ttlcost-val").val())/(parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100))*100).toFixed(0)),$(".hidden-percent").show(),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$(".hidden-percent").hide(),$("#total-weightedcm").empty().text("")):""!=$("#total-ttlcost-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())-$("#total-ttlcost-val").val())/parseFloat($("#total-ttlsales-val").val())*100).toFixed(0)),$(".hidden-percent").show(),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$(".hidden-percent").hide(),$("#total-weightedcm").empty().text("")))}function calculateTotalCost(){var e=_table.getColumnData(30).filter((e=>!isNaN(e)&&isFinite(e)&&""!=e&&null!=e&&null!=e));e.length>0&&($("#total-ttlcost-val").val(e.reduce(((e,l)=>e+parseFloat(l)),0)),$("#total-ttlcost").empty().text($("#total-ttlcost-val").val()),""!=$(".js-rb-rebate").val()?""!=$("#total-ttlsales-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100)-$("#total-ttlcost-val").val())/(parseFloat($("#total-ttlsales-val").val())*(1-parseFloat($(".js-rb-rebate").val())/100))*100).toFixed(0)),$(".hidden-percent").show(),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$(".hidden-percent").hide(),$("#total-weightedcm").empty().text("")):""!=$("#total-ttlsales-val").val()?($("#total-weightedcm-val").val(((parseFloat($("#total-ttlsales-val").val())-$("#total-ttlcost-val").val())/parseFloat($("#total-ttlsales-val").val())*100).toFixed(0)),$(".hidden-percent").show(),$("#total-weightedcm").empty().text($("#total-weightedcm-val").val())):($("#total-weightedcm-val").val(""),$(".hidden-percent").hide(),$("#total-weightedcm").empty().text("")))}function formatAsPercent(e){return new Intl.NumberFormat("default",{style:"percent",minimumFractionDigits:0,maximumFractionDigits:0}).format(e/100)}function getDataFail(e){$(".preload").removeClass("d-flex"),Swal.fire({icon:"error",title:"Error! Pls try again",showConfirmButton:!0})}function insertRow(){let e=Number(document.getElementById("txt-row").value);for(let l=0;l<e;l++)_table.insertRow(_declareSingleData(33));"Yes"==$("#sl-weighted-cm").val()?(_table.showColumn(27),_table.showColumn(28),_table.showColumn(29),_table.showColumn(30)):(_table.hideColumn(27),_table.hideColumn(28),_table.hideColumn(29),_table.hideColumn(30))}function userData(e){null==e&&Swal.fire({icon:"error",title:"Error! Cannot get username",showConfirmButton:!0}),$("#requestor").empty().text(e.displayname),_approvalNames=e}function filterUniqueLevel(e){console.log("DATA"),console.log(e);let l=new Set(e);return console.log("MAP DATA"),console.log(l),_approvalNames.round.map((e=>{l.has(e)||l.delete(e)})),[...l]}function findUserRef(e,l,t){$("#level-2").empty().text(""),$("#level-3").empty().text(""),$("#level-4").empty().text("");var a={level2:null,level3:null,level4:null,requestor:_approvalNames.requestor,displayname:_approvalNames.displayname,to:null,cc:[],gpd:["gpdvn_record@ap.averydennison.com"],round:["lv2","lv3","lv4"]};switch(a.level4=_approvalNames.level4,a.level3=_approvalNames.level3,a.level2=_approvalNames.level2,t.map((e=>{a.gpd.push(`${e}@ap.averydennison.com`)})),a.cc.push(_approvalNames.requestor),l){case 2:a.to=_approvalNames.level2;break;case 3:a.to=_approvalNames.level3,""!=_approvalNames.level2&&null!=_approvalNames.level2&&null!=_approvalNames.level2&&(a.to=_approvalNames.level2);break;case 4:a.to=_approvalNames.level4,""!=_approvalNames.level3&&null!=_approvalNames.level3&&null!=_approvalNames.level3&&(a.to=_approvalNames.level3),""!=_approvalNames.level2&&null!=_approvalNames.level2&&null!=_approvalNames.level2&&(a.to=_approvalNames.level2);break;default:a.to=_approvalNames.requestor}switch(e){case 4:return $("#level-3").empty().text(_approvalNames.level3),$("#level-4").empty().text(_approvalNames.level4),""!=_approvalNames.level2?$("#level-2").empty().text(_approvalNames.level2):(-1!==a.round.indexOf("lv2")&&a.round.splice(a.round.indexOf("lv2"),1),a.level2=""),a.round=filterUniqueLevel(a.round),a;case 3:return $("#level-3").empty().text(_approvalNames.level3),-1!==a.round.indexOf("lv4")&&(a.round.splice(a.round.indexOf("lv4"),1),a.level4=""),""==_approvalNames.level2?(-1!==a.round.indexOf("lv2")&&a.round.splice(a.round.indexOf("lv2"),1),a.level2=""):$("#level-2").empty().text(_approvalNames.level2),a.round=filterUniqueLevel(a.round),a;case 2:return-1!==a.round.indexOf("lv4")&&(a.round.splice(a.round.indexOf("lv4"),1),a.level4=""),""==_approvalNames.level2?(-1!==a.round.indexOf("lv2")&&(a.round.splice(a.round.indexOf("lv2"),1),a.level2=""),a.level2="",$("#level-3").empty().text(_approvalNames.level3)):(-1!==a.round.indexOf("lv3")&&a.round.splice(a.round.indexOf("lv3"),1),a.level3="",$("#level-2").empty().text(_approvalNames.level2)),a.round=filterUniqueLevel(a.round),a;default:return a.to=_approvalNames.requestor,a.cc=a.gpd,a.round=[""],a.round=filterUniqueLevel(a.round),a}}function renderDuplicateRow(e){return e.map((e=>`<p>GLID: ${e[2]} - Bill to code: ${e[1]} already exist in <a href="javascript:void(0);">database</a>, request Id: ${e[0]}</p>`)).join("</br>")}$(".hidden-percent").hide(),$("#rounded-div").show(),$("#neededspecialprice-round-to").val(_neeededSpecialPriceRound),window.onscroll=function(){scrollFunction()},$(document).on("change","#neededspecialprice-round-to",(function(){""!=$("#neededspecialprice-round-to").val()&&null!=$("#neededspecialprice-round-to").val()&&null!=$("#neededspecialprice-round-to").val()&&_setNeededSpecialPriceRoundTo($("#neededspecialprice-round-to").val())})),$(document).on("click","#btn-export",(async function(){await saveAsExcel()})),_slWC.onchange=function(){null!=_table&&("Yes"==this.value?(_table.showColumn(27),_table.showColumn(28),_table.showColumn(29),_table.showColumn(30)):(_table.hideColumn(27),_table.hideColumn(28),_table.hideColumn(29),_table.hideColumn(30)))},_inRBrebate.onchange=function(){isNaN(this.value)||null!=_table&&null!=_table.getJson()&&(_table.getJson().map(((e,l)=>{try{calculateCM(l)}catch{return}})),calculateTotalSales(),calculateTotalCost())},google.script.run.withFailureHandler(getDataFail).withSuccessHandler((e=>{if(console.log("res"),console.log(e),_exchangeRateValue=parseInt(e.exchangerate),_minExchangeRateValue=parseInt(e.minExchangerate),null==e.users)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"You do not have permission to access this page! Please contact to sales admin",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1});_table=jspreadsheet(document.getElementById("spreadsheet"),{data:_declareData(100,33),tableOverflow:!0,allowDeleteColumn:!1,allowManualInsertColumn:!1,autoIncrement:!1,allowInsertColumn:!1,rowResize:!0,columns:[{type:"dropdown",title:"Bill-to Name",width:"180",id:"required",name:"billtoname",autocomplete:!0,source:e.billtocode.filter((e=>"LH"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency}))),filter:function(l,t,a,r,o){switch($("#sl-site").val()){case"LH":return e.billtocode.filter((e=>"LH"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));case"FRU":return e.billtocode.filter((e=>"FRU"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));case"KHT":return e.billtocode.filter((e=>"KHT"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));case"KHM":return e.billtocode.filter((e=>"KHM"==e.site)).map((e=>({id:e.btoName,name:e.btoName,title:e.curency})));default:return o}}},{type:"text",title:"GLID",width:"150",name:"glid",id:"required",readOnly:!1},{type:"hidden",title:"Bill-to Code",width:"150",id:"readonly",name:"billtocode",readOnly:!0},{type:"text",title:"Currency",width:"150",id:"readonly",name:"currency",readOnly:!0},{type:"text",title:"Sold To Name",width:"150",id:"readonly",name:"soldtoname",readOnly:!0},{type:"text",title:"Customer Item",width:"150",name:"customeritem",id:"readonly",readOnly:!0},{type:"text",title:"Production Method",width:"150",id:"readonly",name:"productionmethod",readOnly:!0},{type:"dropdown",title:"Make/Buy",width:"120",name:"makebuy",id:"readonly",source:["Make","Buy"],readOnly:!0},{type:"text",title:"Cost",width:"100",name:"cost",id:"readonly",readOnly:!1},{type:"number",title:"Std price\n(USD)",width:"120",id:"readonly",name:"stdpriceusd",readOnly:!0},{type:"number",title:"Std price\n(VND)",width:"80",name:"stdpricevnd",id:"readonly",readOnly:!0},{type:"number",title:"Current special price\n(USD)",width:"160",name:"currentspecialpriceusd",id:"readonly",readOnly:!0},{type:"number",title:"Current special price\n(VND)",width:"160",name:"currentspecialpricevnd",id:"readonly",readOnly:!0},{type:"dropdown",title:"D2D price",width:"120",name:"d2dprice",source:[{id:"Yes",name:"Yes"},{id:"No",name:"No"}],id:"required",readOnly:!1},{type:"number",title:"Freight fee",width:"170",name:"freightfee",id:"required"},{type:"dropdown",title:"Different\nexchange rate",width:"120",name:"differentexchangerate",source:[{id:"Yes",name:"Yes"},{id:"No",name:"No"}],readOnly:!1,id:"required"},{type:"number",title:"Exchange rate",width:"170",name:"exchangerate",id:"required"},{type:"number",title:"Needed special\nprice",width:"170",name:"neededspecialprice"},{type:"number",title:"CM",width:"100",name:"cm",id:"readonly",readOnly:!0},{type:"calendar",title:"Effective Date",width:"150",name:"effectivedate",id:"required",options:{format:"DD/Mon/YYYY"}},{type:"calendar",title:"End Date",width:"150",name:"enddate",options:{format:"DD/Mon/YYYY"}},{type:"text",title:"Season\n(for UQ/HM only)",width:"170",name:"season"},{type:"dropdown",title:"RB",width:"150",id:"required",name:"rb",autocomplete:!0,source:e.rbos},{type:"dropdown",title:"Production",width:"180",id:"required",name:"productline",autocomplete:!0,source:e.plmake.concat(e.plbuy),filter:function(l,t,a,r,o){switch(l.jspreadsheet.getValueFromCoords(4,r,!1)){case"Make":return e.plmake;case"Buy":return e.plbuy;default:return e.plmake.concat(e.plbuy)}}},{type:"dropdown",title:"Market Segment",width:"180",id:"required",name:"marketsegment",autocomplete:!0,readOnly:!1,source:e.markets},{type:"text",title:"Approval level",width:"200",name:"approvallevel",id:"readonly",readOnly:!0},{type:"dropdown",title:"GPD in charge & Carbon Copy",width:"240",name:"gpdincharge",autocomplete:!0,readOnly:!1,source:e.gpd,multiple:!0},{type:"number",title:"TTL Sales QTY",width:"140",id:"required",name:"ttlsalesqty"},{type:"text",title:"TTL Produced QTY\n(if there alignment of free loss)",width:"160",name:"ttlproducedqty"},{type:"number",title:"TTL sales",width:"100",name:"ttlsales",id:"readonly",readOnly:!0},{type:"number",title:"TTL cost",width:"100",name:"ttlcost",id:"readonly",readOnly:!0},{type:"hidden",title:"Start Date",width:"100",name:"startdate",id:"readonly",readOnly:!0},{type:"hidden",title:"Manual Input Cost",width:"100",name:"manualinputcost",id:"readonly",readOnly:!0}],onbeforechange:function(l,t,a,r,o){switch(Number(a)){case 0:if(_table.ignoreEvents=!0,_table.getCell(`I${Number(r)+1}`).classList.add("readonly"),""!=o&&null!=o&&null!=o){let l=o.split(" ")[0],t=e.billtocode.find((e=>e.site==$("#sl-site").val()&&e.btoCode==l.trim()));_table.setValue(`C${Number(r)+1}`,l,!0),_table.setValue(`D${Number(r)+1}`,null==t||null==t?null:t.curency,!0),null!=t&&null!=t&&("USD"==t.curency?($("#rounded-div").show(),_table.getCell(`P${Number(r)+1}`).classList.add("readonly"),_table.getCell(`Q${Number(r)+1}`).classList.add("readonly"),_table.setValue(`P${Number(r)+1}`,null,!0),""!=_table.getValue(`Q${Number(r)+1}`)&&null!=_table.getValue(`Q${Number(r)+1}`)&&null!=_table.getValue(`Q${Number(r)+1}`)||_table.setValue(`Q${Number(r)+1}`,null,!0)):($("#rounded-div").hide(),_table.getCell(`P${Number(r)+1}`).classList.remove("readonly"),_table.getCell(`Q${Number(r)+1}`).classList.remove("readonly")),calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,t.curency),Number(r)+1))}else _table.getCell(`P${Number(r)+1}`).classList.remove("readonly"),_table.getCell(`Q${Number(r)+1}`).classList.remove("readonly"),_table.setValue(`C${Number(r)+1}`,null,!0),_table.setValue(`D${Number(r)+1}`,null,!0),calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,currency.curency),Number(r)+1);_table.ignoreEvents=!1;break;case 1:_table.ignoreEvents=!0,_table.getCell(`I${Number(r)+1}`).classList.add("readonly"),_table.ignoreEvents=!1;break;case 8:_table.ignoreEvents=!0,_table.setValue(`I${Number(r)+1}`,o,!0),calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${Number(r)+1}`)),Number(r)+1),_table.setValue(`AG${Number(r)+1}`,"Y",!0),_table.ignoreEvents=!1;break;case 13:_table.ignoreEvents=!0,_table.setValue(`N${Number(r)+1}`,o,!0),"No"==o?(_table.getCell(`O${Number(r)+1}`).classList.add("readonly"),_table.setValue(`O${Number(r)+1}`,null,!0)):(_table.getCell(`O${Number(r)+1}`).classList.remove("readonly"),_table.setValue(`O${Number(r)+1}`,0,!0)),calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${Number(r)+1}`)),Number(r)+1),_table.ignoreEvents=!1;break;case 14:if(_table.ignoreEvents=!0,_table.setValue(`O${Number(r)+1}`,o,!0),isNaN(o))break;""!=o&&calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${Number(r)+1}`)),Number(r)+1),_table.ignoreEvents=!1;break;case 15:_table.ignoreEvents=!0,_table.setValue(`P${Number(r)+1}`,o,!0),"No"==o?(_table.getCell(`Q${Number(r)+1}`).classList.add("readonly"),_table.setValue(`Q${Number(r)+1}`,null,!0)):(_table.setValue(`Q${Number(r)+1}`,_exchangeRateValue,!0),_table.getCell(`Q${Number(r)+1}`).classList.remove("readonly")),calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${Number(r)+1}`)),Number(r)+1),_table.ignoreEvents=!1;break;case 16:if(_table.ignoreEvents=!0,_table.setValue(`Q${Number(r)+1}`,o,!0),Number(o)<_minExchangeRateValue&&Swal.fire({title:`Exchange rate is less than ${_minExchangeRateValue}`,icon:"question",showConfirmButton:!0}),isNaN(o))return;if(""!=o){calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${Number(r)+1}`)),Number(r)+1);try{calculateCM(Number(r)+1)}catch{return}}_table.ignoreEvents=!1;break;case 17:_table.ignoreEvents=!0,_table.setValue(`R${Number(r)+1}`,o,!0),calculateNeededSpecialPriceEachRow(_mapCurrencyValueInFT(0,_table.getValue(`D${Number(r)+1}`)),Number(r)+1),console.log("needed special price changed");try{"VND"==_table.getValue(`D${Number(r)+1}`)?""!=_table.getValue(`AB${Number(r)+1}`)&&null!=_table.getValue(`AB${Number(r)+1}`)&&null!=_table.getValue(`AB${Number(r)+1}`)&&"NaN"!=_table.getValue(`AB${Number(r)+1}`)?"Yes"==_table.getValue(`P${Number(r)+1}`)?_table.setValue(`AD${Number(r)+1}`,(parseFloat(o)*(parseFloat(_table.getValue(`AB${Number(r)+1}`))/parseFloat(_table.getValue(`Q${Number(r)+1}`)))).toFixed(0),!0):_table.setValue(`AD${Number(r)+1}`,(parseFloat(o)*(parseFloat(_table.getValue(`AB${Number(r)+1}`))/parseFloat(_exchangeRateValue))).toFixed(0),!0):_table.setValue(`AD${Number(r)+1}`,null,!0):""!=_table.getValue(`AB${Number(r)+1}`)&&null!=_table.getValue(`AB${Number(r)+1}`)&&null!=_table.getValue(`AB${Number(r)+1}`)&&"NaN"!=_table.getValue(`AB${Number(r)+1}`)?_table.setValue(`AD${Number(r)+1}`,(parseFloat(o)*parseFloat(_table.getValue(`AB${Number(r)+1}`))).toFixed(0),!0):_table.setValue(`AD${Number(r)+1}`,null,!0),calculateTotalSales()}catch{return _table.setValue(`AD${Number(r)+1}`,null,!0),$("#total-ttlsales-val").val(""),$("#total-ttlcost-val").val(""),$("#total-weightedcm-val").val(""),$("#total-ttlsales").empty().text(""),$("#total-ttlcost").empty().text(""),void $("#total-weightedcm").empty().text("")}_table.ignoreEvents=!1;break;case 22:_table.ignoreEvents=!0;const l=e.lkrbms.filter((e=>{if(e[0]==o)return e[1]}));0!=l.length?(_table.setValue(`Y${Number(r)+1}`,l[0][1],!0),_table.getCell(`Y${Number(r)+1}`).style.border=""):(_table.setValue(`Y${Number(r)+1}`,null,!0),_table.getCell(`Y${Number(r)+1}`).style.border="0.5px solid red"),_table.ignoreEvents=!1;break;case 27:_table.ignoreEvents=!0;try{"VND"==_table.getValue(`D${Number(r)+1}`)?"Yes"==_table.getValue(`P${Number(r)+1}`)?_table.setValue(`AD${Number(r)+1}`,(parseFloat(o)*(parseFloat(_table.getValue("R{Number(y) + 1}"))/parseFloat(_table.getValue(`Q${Number(r)+1}`)))).toFixed(0),!0):_table.setValue(`AD${Number(r)+1}`,(parseFloat(o)*(parseFloat(_table.getValue(`R${Number(r)+1}`))/parseFloat(_exchangeRateValue))).toFixed(0),!0):_table.setValue(`AD${Number(r)+1}`,(parseFloat(_table.getValue(`R${Number(r)+1}`))*parseFloat(o)).toFixed(0),!0),calculateTotalSales()}catch{return _table.setValue(`AD${Number(r)+1}`,null,!0),$("#total-ttlsales-val").val(""),$("#total-ttlcost-val").val(""),$("#total-weightedcm-val").val(""),$("#total-ttlsales").empty().text(""),$("#total-ttlcost").empty().text(""),void $("#total-weightedcm").empty().text("")}_table.ignoreEvents=!1;break;case 28:_table.ignoreEvents=!0;try{_table.setValue(`AE${Number(r)+1}`,(parseFloat(o)*parseFloat(_table.getValue(`I${Number(r)+1}`))).toFixed(0),!0),calculateTotalCost()}catch{return _table.setValue(`AE${Number(r)+1}`,null,!0),$("#total-ttlsales-val").val(""),$("#total-ttlcost-val").val(""),$("#total-weightedcm-val").val(""),$("#total-ttlsales").empty().text(""),$("#total-ttlcost").empty().text(""),void $("#total-weightedcm").empty().text("")}_table.ignoreEvents=!1;break;default:return o}},onchange:function(e,l,t,a,r,o){switch(Number(t)){case 0:case 1:case 8:case 13:case 14:case 15:case 16:case 17:case 18:case 22:case 23:case 24:o!=r&&($("#btn-submit-glid").show(),$("#btn-submit").hide());break;case 7:r!=o&&_table.setValue(`Y${Number(a)+1}`,null,!0)}},onpaste(e,l){if(!(l[0].length>33))return l;Swal.fire({icon:"error",title:"Value you just pasted is longer than the length of the _table. Do not submit! Pls check again",showConfirmButton:!0})}}),userData(e.users),$(".preload").removeClass("d-flex")})).getInitalDataAsync("PX"),$(document).on("click","#btn-submit-glid",(async function(){var e=_table.getJson();let l=[];if(e.map(((e,t)=>{""==e.glid||null==e.glid||null==e.glid?_table.deleteRow(t):l.push({glid:e.glid,billtocode:e.billtocode})})),l.length>0){let t=e.map((e=>e.currency)).filter((e=>""!=e)),a=[...new Set(t)];if(1!=a.length)return void Swal.fire({icon:"error",title:"Do not submit multiple currency values at same time! Pls check the Currency column again",showConfirmButton:!0});const r=l.reduce(((e,l)=>((objectFound=e.find((e=>e.glid===l.glid&&e.billtocode===l.billtocode)))?objectFound.times++:(l.times=1,e.push(l)),e)),[]);if(r.filter((e=>e.times>1)).length>0){let e=r.filter((e=>e.times>1));return void Swal.fire({icon:"error",title:`GLID: ${e[0].glid}, bill to code: ${e[0].billtocode} is duplicated ${e[0].times-1} time${e[0].times-1>1?"s":""}.`,showConfirmButton:!0})}$(".preload").addClass("d-flex");let o=_mapCurrencyValueInFT(0,a[0]),n=_mapSiteValueInFT($("#sl-site").val());await _promiseGetDataPX(n,["5","6"],l.map((e=>e.glid))).then((e=>e.results?(console.log("px data.results"),console.log(e.results),_table.ignoreEvents=!0,l.map(((l,t)=>{let a=e.results.find((e=>e.glid==l.glid&&5==e.itemtype)),r=e.results.find((e=>e.glid==l.glid&&6==e.itemtype)),o=null==a||null==a?null==r||null==r?null:r:a;_table.setValue(`J${t+1}`,null==a||null==a?null:a.price,!0),_table.setValue(`K${t+1}`,null==r||null==r?null:r.price,!0),null==o||null==o?(_table.setValue(`B${t+1}`,l.glid,!0),_table.setValue(`E${t+1}`,null,!0),_table.setValue(`F${t+1}`,null,!0),_table.setValue(`G${t+1}`,null,!0),_table.setValue(`H${t+1}`,null,!0),_table.getValue("Y"==`AG${t+1}`)&&""!=_table.getValue(`I${t+1}`)&&null!=_table.getValue(`I${t+1}`)&&null!=_table.getValue(`I${t+1}`)&&0!=_table.getValue(`I${t+1}`)||(_table.setValue(`I${t+1}`,null,!0),_table.setValue(`AG${t+1}`,"N",!0))):(_table.setValue(`B${t+1}`,o.glid,!0),_table.setValue(`E${t+1}`,o.rb,!0),_table.setValue(`F${t+1}`,o.itemcode,!0),_table.setValue(`G${t+1}`,o.productmethod,!0),_table.setValue(`H${t+1}`,o.source,!0),_table.getValue("Y"==`AG${t+1}`)&&""!=_table.getValue(`I${t+1}`)&&null!=_table.getValue(`I${t+1}`)&&null!=_table.getValue(`I${t+1}`)&&0!=_table.getValue(`I${t+1}`)||(_table.setValue(`I${t+1}`,o.cost,!0),_table.setValue(`AG${t+1}`,"N",!0)))})),_table.ignoreEvents=!1,_promiseGetDataDC(n,["7","8"],l.map((e=>e.glid)))):($(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"GLID not found",showConfirmButton:!0})))).then((e=>{console.log("discount data:"),console.log(e.results),e.results&&(o=_mapCurrencyValueInFT(1,a[0]),_table.ignoreEvents=!0,l.map(((l,t)=>{let a=e.results.filter((e=>e.glid==l.glid&&e.modifiernumber==`VN${l.billtocode}`&&7==e.itemtype)),r=e.results.filter((e=>e.glid==l.glid&&e.modifiernumber==`VN${l.billtocode}`&&8==e.itemtype));if(a.length>0)if(a.filter((e=>null!=e.price)).length>0){let e=a.filter((e=>null!=e.price)).filter((e=>null!=e.startdate));if(e){let l=e.map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YYYY").format("DD/MMM/YYYY"),"days")));console.log("max date 3: ",Math.max(...l));let a=l.indexOf(Math.max(...l));_table.setValue(`L${t+1}`,e[a].price,!0),_table.setValue(`AF${t+1}`,e[a].startdate,!0)}}else console.log("discount price usd null"),_table.setValue(`L${t+1}`,null,!0),_table.setValue(`AF${t+1}`,null,!0);else console.log("glid with discount price usd not found"),_table.setValue(`L${t+1}`,null,!0),_table.setValue(`AF${t+1}`,null,!0);if(r.length>0)if(r.filter((e=>null!=e.price)).length>0){let e=r.filter((e=>null!=e.price)).filter((e=>null!=e.startdate));if(e){let l=e.map((e=>moment(moment(new Date).format("DD/MM/YYYY"),"DD/MM/YYYY").diff(moment(e.startdate,"DD/MM/YYYY").format("DD/MMM/YYYY"),"days")));console.log("max date 3: ",Math.max(...l));let a=l.indexOf(Math.max(...l));_table.setValue(`M${t+1}`,e[a].price,!0),""!=_table.getValue(`L${t+1}`)&&null!=_table.getValue(`L${t+1}`)&&null!=_table.getValue(`L${t+1}`)||_table.setValue(`AF${t+1}`,e[a].startdate,!0)}}else console.log("discount price VND null"),_table.setValue(`M${t+1}`,null,!0),""!=_table.getValue(`L${t+1}`)&&null!=_table.getValue(`L${t+1}`)&&null!=_table.getValue(`L${t+1}`)||_table.setValue(`AF${t+1}`,null,!0);else console.log("glid with discount price VND not found"),_table.setValue(`M${t+1}`,null,!0),""!=_table.getValue(`L${t+1}`)&&null!=_table.getValue(`L${t+1}`)&&null!=_table.getValue(`L${t+1}`)||_table.setValue(`AF${t+1}`,null,!0);calculateNeededSpecialPriceEachRow(o,t+1)})),_table.ignoreEvents=!1)})).catch((e=>{console.log("promise err: ",e),$(".preload").removeClass("d-flex")})),await _promisePreviewData().then((()=>{console.log("_promisePreviewData finished")}))}})),$(document).on("click","#btn-submit",(function(){if($("#form-submit").valid()){var e=_table.getJson();$(".preload").addClass("d-flex"),$.ajax({url:"https://script.google.com/a/macros/ap.averydennison.com/s/AKfycbzZXbC2NZpDCQxwiyxYKZLPDu-0YPU19OL8YjvxoSgiloaj0wbCmhFSvcR2a_g-MgFE/exec",dataType:"JSONP",async:!1,jsonpCallback:"callback",type:"GET",success:async function(l){token=l,console.log(token);var t=[],a={time:moment(new Date).format("hh:mm:ss A"),requestor:null,date:moment(new Date).format("DD-MMM-YYYY"),tcnno:"this is tcn no"},r=0,o=[];if(e.map(((e,l)=>{Object.keys(e).every((l=>""==e[l]))||(e.index=l,o.push(e))})),o.length<=0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Table is null. Pls fill!",showConfirmButton:!0});var n=[];n="Yes"==$("#sl-weighted-cm").val()?_columnvalidateYes:_columnvalidateNo;for(var u=0;u<o.length;u++){var i=0;for(var s in e[u]){if(""===e[u][s]&&n.includes(i))return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:s+" at row "+(u+1)+" is blank. Pls check again!",showConfirmButton:!0});i++}if(Number(e[u].freightfee)<0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Freight fee column: Do not input negative value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if(Number(e[u].exchangerate)<0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Exchange rate column: Do not input negative value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if(Number(e[u].cm)<0)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM column: Do not input negative value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if(""==e[u].gpdincharge||null==e[u].gpdincharge||null==e[u].gpdincharge)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"GPD in charge column: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("!err"==e[u].makebuy)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Make/Buy column: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("!err"==e[u].productline)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Product line: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("NaN"==e[u].neededspecialprice)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Needed special price: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("NaN"==e[u].cm)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"CM: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("Yes"==$("#sl-weighted-cm").val()){if("NaN"==e[u].ttlsales)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL sales: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0});if("NaN"==e[u].ttlcost)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"TTL Cost: Invalid value at row: "+(u+1)+". Pls check again",showConfirmButton:!0})}r++,$("#form-submit").serializeArray().map(((l,t)=>{e[u][l.name]=l.value})),e[u].totalttlsales=$("#total-ttlsales-val").val(),e[u].totalttlcost=$("#total-ttlcost-val").val(),e[u].totalweightedcm=$("#total-weightedcm-val").val(),e[u].requestorremark=$("#remark_requestor").val(),e[u].requesttype=_requestType,e[u].effectivedate=null==e[u].effectivedate||""===e[u].effectivedate||null==e[u].effectivedate?null:moment(e[u].effectivedate).format("DD/MMM/YYYY"),e[u].enddate=null==e[u].enddate||""===e[u].enddate||null==e[u].enddate?null:moment(e[u].enddate).format("DD/MMM/YYYY"),t.push({...a,...e[u]})}if(0==r)return $(".preload").removeClass("d-flex"),void Swal.fire({icon:"error",title:"Do not submit null value!",showConfirmButton:!0});var d=[],c=0,m=4;let b=_table.getColumnData(26).filter((e=>""!=e&&null!=e&&null!=e));b.length>0&&b.map((e=>{e.split(";").map((e=>{""!=e&&d.push(e)}))})),d=[...new Set(d)];let p=_table.getColumnData(25).filter((e=>""!=e&&null!=e&&null!=e));p.length>0&&p.map((e=>{var l=e.replace(/\D+/g,"");""==l?l=0:(Number(l)>c&&(c=Number(l)),Number(l)<m&&(m=Number(l)))})),console.log("arr2417: ",t),google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){if(null!=e)return void Swal.fire({title:"Warning",icon:"warning",html:renderDuplicateRow(e),confirmButtonText:"OK",allowOutsideClick:!1}).then((e=>{e.isConfirmed,$(".preload").removeClass("d-flex")}));let l=findUserRef(c,m,d);console.log("user:",l),google.script.run.withFailureHandler(getDataFail).withSuccessHandler((function(e){$(".preload").removeClass("d-flex"),e.suc?Swal.fire({icon:"success",title:"Done! Email has sent",showConfirmButton:!0}):Swal.fire({icon:"error",title:e.msg,showConfirmButton:!0})})).AddNew(t,l,token)})).checkDuplicate(t.map((e=>({billtocode:e.billtocode,glid:e.glid,neededspecialprice:e.neededspecialprice,requesttype:e.requesttype}))))},error:function(){$(".preload").removeClass("d-flex"),console.log("ajax error get token"),Swal.fire({icon:"error",title:"Error while get token",showConfirmButton:!0})}})}else Swal.fire({icon:"error",title:"Form is invalid!",showConfirmButton:!0})})),$(document).on("click","#btn-add-row",(()=>{insertRow()}));